[file content start]
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Acolhidos - ADRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: white;
            color: #34495e;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: #004d4d;
            color: white;
            padding: 20px;
            width: 100%;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        header img {
            max-width: 200px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: #c0392b; }
        
        .main-info {
            background: #e0e6f1;
            padding: 15px 25px;
            margin: 20px 0;
            border-radius: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            width: 80%;
            max-width: 400px;
        }
        .info-title-container {
            background: #005952;
            color: white;
            padding: 15px 25px;
            margin: -25px -25px 15px -25px;
            border-radius: 20px;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .info-title-container h2 {
            margin: 0;
            font-size: 1.8em;
            letter-spacing: 2px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-connected { background: #27ae60; color: white; }
        .status-connecting { background: #f39c12; color: white; }
        .status-error { background: #e74c3c; color: white; }
        .access-level-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .access-admin { background: #e74c3c; color: white; }
        .access-tecnico { background: #3498db; color: white; }
        .access-portaria { background: #95a5a6; color: white; }
        
        .search-area-button {
            background: #005952;
            color: white;
            padding: 15px 20px;
            margin: 20px 0 10px;
            border-radius: 9999px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            max-width: 300px;
            border: 2px solid white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .search-area-button:hover {
            background: #007a6e;
            transform: translateY(-2px);
        }
        .search-area-button i { font-size: 1.5em; margin-right: 10px; }
        
        .search-container {
            width: 80%;
            max-width: 500px;
            background: #005952;
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .search-input-container {
            display: flex;
            width: 100%;
            margin-top: 10px;
            position: relative;
        }
        .search-input-container input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            margin-right: 5px;
            font-size: 16px;
        }
        .search-input-container button {
            background: #27ae60;
            color: white;
            border: 2px solid white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 80px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .autocomplete-item:hover { background: #e8f5e9; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-restriction {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .search-results {
            width: 80%;
            max-width: 500px;
            display: none;
            margin-bottom: 20px;
        }

        .search-results-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }

        .acolhido-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .acolhido-header > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .acolhido-name {
            margin: 0;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: bold;
            flex: 1;
        }

        .restriction-badge-large {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            background: #e74c3c;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-results-btn {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .close-results-btn:hover {
            background: #7f8c8d;
            transform: scale(1.1);
        }

        .info-section {
            margin-bottom: 18px;
        }

        .info-label {
            color: #005952;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .info-value {
            color: #34495e;
            font-size: 1.1em;
            line-height: 1.5;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .restriction-section .info-value {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .restriction-section .info-label {
            color: #856404;
        }

        .action-buttons-search {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            justify-content: center;
        }

        .action-buttons-search button {
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            font-size: 1em;
            transition: all 0.2s;
            min-width: 120px;
        }

        .action-buttons-search button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .edit-btn-search {
            background: #3498db;
            color: white;
        }

        .print-btn-search {
            background: #2c3e50;
            color: white;
        }

        .transfer-btn-search {
            background: #9b59b6;
            color: white;
        }
        
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 80%;
            max-width: 400px;
            margin: 20px auto;
        }
        .grid-item {
            background: #005952;
            color: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .grid-item.danger { background: #c0392b; }
        .grid-item.danger:hover { background: #a93226; }
        .grid-item.disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .grid-item.disabled:hover { transform: none; }
        .grid-item i { font-size: 3em; margin-bottom: 10px; }
        .grid-item span {
            display: block;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .content-area {
            padding: 20px;
            width: 90%;
            max-width: 800px;
        }
        .content-area h2 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .registration-form {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 20px auto;
        }
        .registration-form label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #2c3e50;
        }
        .registration-form input,
        .registration-form textarea,
        .registration-form select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
        }
        .registration-form button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            margin-top: 20px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        .registration-form button:hover { background: #229954; }
        
        .collapsible {
            background-color: #27ae60;
            color: white;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 2px solid white;
            text-align: left;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .collapsible:hover { background-color: #229954; }
        .collapsible:after {
            content: '+';
            font-size: 1.5em;
            float: right;
        }
        .collapsible.active:after { content: "-"; }
        .collapsible-content {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .collapsible-content p {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .action-buttons button {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid;
        }
        .delete-btn { background: #e74c3c; color: white; }
        .print-btn { background: #3498db; color: white; }
        .edit-btn { background: #5d5d5d; color: white; }
        .transfer-btn { background: #9b59b6; color: white; }
        .exit-btn { background: #e67e22; color: white; }
        .entry-btn { background: #27ae60; color: white; }
        
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #2c3e50;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
            display: none;
            max-width: 90%;
            white-space: pre-wrap;
        }
        .message-box button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
        }
        
        .movement-record {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .movement-record.exit-record {
            border-left-color: #e67e22;
        }
        .movement-record.entry-record {
            border-left-color: #27ae60;
        }
        .movement-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .movement-actions button {
            padding: 4px 8px;
            font-size: 0.75em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .edit-movement-btn { background: #3498db; }
        .delete-movement-btn { background: #e74c3c; }
        .movements-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #005952;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        .data-popup h3 {
            color: #005952;
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 10px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #005952;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .data-table tr:hover {
            background: #e8f5e9;
        }
        .data-table .date-column {
            white-space: nowrap;
            width: 120px;
            background: #e8f5e9;
            font-weight: bold;
        }
        .data-table .day-column {
            white-space: nowrap;
            width: 80px;
            background: #e3f2fd;
            font-weight: bold;
        }
        .data-table .time-column {
            white-space: nowrap;
            width: 80px;
            background: #fff3e0;
            font-weight: bold;
        }
        .data-table th.date-column {
            background: #27ae60;
        }
        .data-table th.day-column {
            background: #3498db;
        }
        .data-table th.time-column {
            background: #e67e22;
        }
        .close-popup {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            float: right;
        }
        .close-popup:hover {
            background: #c0392b;
        }

        .sheet-selection {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #005952;
        }
        .sheet-selection h4 {
            color: #005952;
            margin-bottom: 10px;
            text-align: center;
        }
        .sheets-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        .sheet-option {
            background: white;
            border: 2px solid #005952;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        .sheet-option:hover {
            background: #e8f5e9;
            transform: translateY(-2px);
        }
        .sheet-option.selected {
            background: #005952;
            color: white;
        }
        .sheet-info {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }
        .custom-sheet-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .custom-sheet-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }
        .custom-sheet-input button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            #login-container {
                max-width: 100% !important;
                width: 100% !important;
                margin: 5px !important;
                border-radius: 15px !important;
            }
            
            .usuario-option {
                padding: 12px !important;
                margin-bottom: 8px !important;
            }
            
            .login-section {
                margin-bottom: 15px !important;
            }
            
            .login-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .grid-menu {
                grid-template-columns: 1fr;
                gap: 15px;
                width: 95%;
            }

            .grid-item {
                padding: 15px;
            }

            .grid-item i {
                font-size: 2.5em;
            }

            .search-container {
                width: 95%;
            }

            .search-results {
                width: 95%;
            }

            .main-info {
                width: 95%;
                padding: 15px;
            }

            .content-area {
                width: 95%;
                padding: 15px;
            }

            .data-popup {
                width: 98%;
                padding: 15px;
            }

            .action-buttons-search {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons-search button {
                min-width: auto;
                width: 100%;
            }

            .sheets-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            #login-container {
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            .usuario-option {
                padding: 10px !important;
            }
            
            #login-container h1 {
                font-size: 1.4em !important;
            }
            
            #login-container h3 {
                font-size: 1.1em !important;
            }

            header {
                padding: 15px;
            }

            header img {
                max-width: 150px;
            }

            .logout-btn {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 10px;
                width: 100%;
            }

            .info-title-container h2 {
                font-size: 1.4em;
            }

            .search-area-button {
                width: 95%;
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .search-input-container {
                flex-direction: column;
            }

            .search-input-container input {
                margin-right: 0;
                margin-bottom: 5px;
            }

            .search-input-container button {
                width: 100%;
            }

            .autocomplete-suggestions {
                right: 0;
            }

            .acolhido-header {
                flex-direction: column;
                gap: 10px;
            }

            .acolhido-name {
                font-size: 1.2em;
            }
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .usuario-option {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            background: #f8f9fa;
        }

        .usuario-option:hover, .usuario-option:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #005952;
            background: #e8f5e9;
        }

        .login-option {
            transition: all 0.3s ease;
        }

        .login-option:active {
            transform: scale(0.98);
            background: #e8f5e9 !important;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            font-size: 16px !important;
        }

        button, 
        .grid-item, 
        .usuario-option,
        .sheet-option {
            min-height: 44px;
        }

        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://files.adventistas.org/v2.adra.org.br/2022/08/22110714/Sem-Titulo-1-2.png" alt="ADRA Logo">
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </header>

    <div class="main-info">
        <div class="info-title-container">
            <h2>Abrigo ADRA</h2>
        </div>
        <div style="margin-top: 10px;">
            <span class="connection-status status-connecting" id="connection-status">Conectando...</span>
            <span class="access-level-badge access-portaria" id="access-badge">PORTARIA</span>
        </div>
        <p style="margin-top: 10px;">Última Atualização: <span id="last-update">Carregando...</span></p>
        <p>Total de Acolhidos Ativos: <span id="total-count">0</span></p>
    </div>

    <div class="search-area-button" onclick="toggleSearch()">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>FUNÇÕES PARA PORTARIA</span>
    </div>

    <div class="search-container" id="searchContainer">
        <div style="text-align: center; font-weight: bold; font-size: 1.1em;">
            <i class="fas fa-search"></i> Buscar Acolhido
        </div>
        <div class="search-input-container">
            <input type="text" id="searchInput" placeholder="Digite o nome do acolhido..." autocomplete="off">
            <div class="autocomplete-suggestions" id="autocompleteSuggestions"></div>
            <button onclick="searchAcolhido()">
                <i class="fas fa-search"></i> Buscar
            </button>
        </div>
    </div>

    <div id="searchResults" class="search-results"></div>

    <div class="grid-menu">
        <div class="grid-item" id="btn-cadastrar" onclick="showRegisterForm()">
            <i class="fas fa-user-plus"></i>
            <span>Cadastrar</span>
        </div>
        <div class="grid-item" onclick="showEntryExitPanel()">
            <i class="fas fa-door-open"></i>
            <span>Entrada/Saída</span>
        </div>
        <div class="grid-item" id="btn-importar" onclick="importExcel()">
            <i class="fa-solid fa-file-excel"></i>
            <span>Importar Excel</span>
        </div>
        <div class="grid-item" onclick="showTechnicians()">
            <i class="fas fa-user-friends"></i>
            <span>Técnicos</span>
        </div>
        <div class="grid-item" onclick="showReports()">
            <i class="fas fa-chart-bar"></i>
            <span>Relatórios</span>
        </div>
        <div class="grid-item" onclick="showAllData()">
            <i class="fas fa-database"></i>
            <span>Carregar Dados</span>
        </div>
        <div class="grid-item" onclick="showRestricted()">
            <i class="fas fa-ban"></i>
            <span>Restritos</span>
        </div>
        <div class="grid-item" onclick="showAcronyms()">
            <i class="fa-solid fa-book"></i>
            <span>Siglas</span>
        </div>
        <div class="grid-item" onclick="exportToPdf()">
            <i class="fa-solid fa-file-pdf"></i>
            <span>Exportar PDF</span>
        </div>
        <div class="grid-item" onclick="exportToExcel()">
            <i class="fa-solid fa-file-excel"></i>
            <span>Exportar Excel</span>
        </div>
        <div class="grid-item" onclick="syncWithGoogleSheet()">
            <i class="fa-brands fa-google-drive"></i>
            <span>Sinc. Google Sheets</span>
        </div>
        <div class="grid-item" onclick="syncTecnicosSheets()">
            <i class="fa-solid fa-user-md"></i>
            <span>Sinc. Abas Técnicos</span>
        </div>
        <div class="grid-item" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i>
            <span>Atualizar</span>
        </div>
        <div class="grid-item danger" id="btn-limpar" onclick="clearAllData()">
            <i class="fa-solid fa-trash-can"></i>
            <span>Limpar Tudo</span>
        </div>
        
        <div class="grid-item" id="btn-senhas" onclick="gerenciarSenhas()" style="display:none;">
            <i class="fas fa-key"></i>
            <span>Gerenciar Usuários</span>
        </div>
    </div>

    <div class="content-area" id="mainContent"></div>

    <div id="dataPopup" class="data-popup">
        <h3></h3>
        <div id="popupContent"></div>
    </div>

    <div id="overlay"></div>
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <div class="button-container">
            <button id="confirm-ok-btn" style="display:none;">OK</button>
            <button id="confirm-cancel-btn" style="display:none;">Cancelar</button>
            <button id="alert-ok-btn" style="display:none;">OK</button>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO DO SUPABASE
        const SUPABASE_URL = 'https://aarpdykhdfsuayoqkkkv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhcnBkeWtoZGZzdWF5b3Fra2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDUyNzQsImV4cCI6MjA3NDY4MTI3NH0.aQYnzGPTax8vWMuuEjyKJlbnKAJfJX7_y1lVLlzJie8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // VARIÁVEIS GLOBAIS
        let allAcolhidos = [];
        let allMovements = [];
        let tecnicos = [];
        let currentAccessLevel = 'portaria';
        let currentTecnico = '';
        let selectedSheet = '';
        let currentSheetId = '';

        // LISTA DE ABAS COMUNS
        const COMMON_SHEETS = [
            'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO',
            'JANEIRO', 'FEVEREIRO', 'MARÇO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO',
            'Página1', 'Sheet1', 'Planilha1', 'Dados', 'Registros'
        ];

        // FUNÇÃO ATUALIZADA: Sistema de login otimizado para mobile
        async function promptAccessLevel() {
            try {
                const { data: usuarios, error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .select('*')
                    .eq('ativo', true)
                    .order('nivel_acesso', { ascending: true });

                if (error) throw error;

                const overlay = document.createElement('div');
                overlay.id = 'login-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: flex-start;
                    z-index: 10002;
                    padding: 10px;
                    overflow-y: auto;
                `;

                const loginContainer = document.createElement('div');
                loginContainer.id = 'login-container';
                loginContainer.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
                    width: 100%;
                    max-width: 95%;
                    margin-top: 20px;
                    margin-bottom: 20px;
                    overflow: hidden;
                    animation: popIn 0.4s ease;
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes popIn {
                        from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                    .usuario-option {
                        transition: all 0.3s ease;
                        border: 2px solid #e9ecef;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 10px;
                        cursor: pointer;
                        background: #f8f9fa;
                    }
                    .usuario-option:hover, .usuario-option:active {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        border-color: #005952;
                        background: #e8f5e9;
                    }
                    .form-group {
                        margin-bottom: 15px;
                    }
                    .form-group label {
                        display: block;
                        margin-bottom: 8px;
                        font-weight: bold;
                        color: #2c3e50;
                    }
                    .form-group input {
                        width: 100%;
                        padding: 12px 15px;
                        border: 1px solid #bdc3c7;
                        border-radius: 8px;
                        font-size: 16px;
                        transition: border 0.3s;
                    }
                    .form-group input:focus {
                        border-color: #005952;
                        outline: none;
                        box-shadow: 0 0 0 2px rgba(0, 89, 82, 0.2);
                    }
                    
                    @media (max-width: 768px) {
                        #login-container {
                            max-height: 85vh;
                            overflow-y: auto;
                        }
                        .login-section {
                            margin-bottom: 20px;
                        }
                        .usuario-option {
                            padding: 12px;
                            margin-bottom: 8px;
                        }
                    }
                `;
                document.head.appendChild(style);

                const usuariosPorNivel = {
                    'portaria': usuarios.filter(u => u.nivel_acesso === 'portaria'),
                    'tecnico': usuarios.filter(u => u.nivel_acesso === 'tecnico'),
                    'admin': usuarios.filter(u => u.nivel_acesso === 'admin')
                };

                let loginHTML = `
                    <div style="background: #005952; color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 10;">
                        <img src="https://files.adventistas.org/v2.adra.org.br/2022/08/22110714/Sem-Titulo-1-2.png" alt="ADRA Logo" style="max-width: 120px; height: auto; border-radius: 8px; margin-bottom: 10px;">
                        <h1 style="font-size: 1.4em; margin: 0; font-weight: bold;">Sistema de Acolhidos</h1>
                        <div style="font-size: 0.8em; opacity: 0.9; margin-top: 5px;">Selecione seu usuário</div>
                    </div>
                    
                    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                `;

                const niveis = [
                    { id: 'portaria', nome: 'Portaria', icon: 'fa-door-closed', color: '#95a5a6' },
                    { id: 'tecnico', nome: 'Técnico', icon: 'fa-user-friends', color: '#3498db' },
                    { id: 'admin', nome: 'Administrador', icon: 'fa-user-shield', color: '#e74c3c' }
                ];

                niveis.forEach(nivel => {
                    const usuariosNivel = usuariosPorNivel[nivel.id];
                    if (usuariosNivel && usuariosNivel.length > 0) {
                        loginHTML += `
                            <div class="login-section" style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 12px; background: ${nivel.color}15; border-radius: 10px;">
                                    <i class="fas ${nivel.icon}" style="color: ${nivel.color}; font-size: 1.3em; margin-right: 12px;"></i>
                                    <h4 style="color: ${nivel.color}; margin: 0; font-size: 1.1em;">${nivel.nome}</h4>
                                </div>
                        `;
                        
                        usuariosNivel.forEach(usuario => {
                            loginHTML += `
                                <div class="usuario-option" data-user='${JSON.stringify(usuario).replace(/'/g, "\\'")}' 
                                     style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer;">
                                    <div style="font-weight: bold; color: #2c3e50; font-size: 1em;">${usuario.usuario_nome}</div>
                                    <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 4px;">Login: ${usuario.login}</div>
                                </div>
                            `;
                        });

                        loginHTML += `</div>`;
                    }
                });

                loginHTML += `
                        </div>
                        
                        <div id="login-form" style="display: none; padding: 20px; border-top: 1px solid #eee; background: #f8f9fa;">
                            <div id="user-info" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
                                <div id="selected-user-name" style="font-weight: bold; font-size: 1.1em;"></div>
                                <div id="selected-user-level" style="font-size: 0.85em; color: #7f8c8d; margin-top: 4px;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="login-password" style="font-size: 0.9em;">Senha:</label>
                                <input type="password" id="login-password" placeholder="Digite sua senha" 
                                       style="width: 100%; padding: 15px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 16px;">
                            </div>
                            
                            <button id="login-btn" style="background: #005952; color: white; border: none; padding: 16px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1.1em; margin-top: 10px;">
                                <i class="fas fa-sign-in-alt"></i> Entrar
                            </button>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="closeLoginPopup()" style="background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 0.9em;">
                                    <i class="fas fa-arrow-left"></i> Voltar para seleção
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                loginContainer.innerHTML = loginHTML;
                overlay.appendChild(loginContainer);
                document.body.appendChild(overlay);

                setupMobileLoginEvents();
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                createMobileLoginPopup();
            }
        }

        // FUNÇÃO: Configurar eventos MOBILE
        function setupMobileLoginEvents() {
            let usuarioSelecionado = null;
            
            document.querySelectorAll('.usuario-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    usuarioSelecionado = JSON.parse(this.getAttribute('data-user'));
                    
                    document.querySelectorAll('.usuario-option').forEach(opt => {
                        opt.style.borderColor = '#e9ecef';
                        opt.style.background = '#f8f9fa';
                    });
                    this.style.borderColor = '#005952';
                    this.style.background = '#e8f5e9';
                    
                    document.getElementById('login-form').style.display = 'block';
                    
                    document.getElementById('login-form').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                    
                    document.getElementById('selected-user-name').textContent = usuarioSelecionado.usuario_nome;
                    
                    const nivelInfo = {
                        'portaria': 'Portaria - Acesso básico para consulta',
                        'tecnico': 'Técnico - Acesso para edição limitada', 
                        'admin': 'Administrador - Acesso completo ao sistema'
                    };
                    document.getElementById('selected-user-level').textContent = nivelInfo[usuarioSelecionado.nivel_acesso];
                    
                    setTimeout(() => {
                        document.getElementById('login-password').focus();
                    }, 300);
                });
            });
            
            document.getElementById('login-btn').addEventListener('click', function() {
                if (!usuarioSelecionado) {
                    showMessageBox('Por favor, selecione um usuário primeiro.');
                    return;
                }
                
                const password = document.getElementById('login-password').value;
                if (password !== usuarioSelecionado.senha) {
                    showMessageBox('Senha incorreta. Tente novamente.');
                    document.getElementById('login-password').focus();
                    return;
                }
                
                currentTecnico = usuarioSelecionado.usuario_nome;
                setAccessLevel(usuarioSelecionado.nivel_acesso);
                closeLoginPopup();
            });
            
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('login-btn').click();
                }
            });
        }

        // FUNÇÃO: Login mobile alternativo
        function createMobileLoginPopup() {
            const overlay = document.createElement('div');
            overlay.id = 'login-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                z-index: 10002;
                padding: 10px;
                overflow-y: auto;
            `;

            const loginContainer = document.createElement('div');
            loginContainer.id = 'login-container';
            loginContainer.style.cssText = `
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.4);
                width: 100%;
                max-width: 95%;
                margin-top: 20px;
                margin-bottom: 20px;
                overflow: hidden;
            `;

            loginContainer.innerHTML = `
                <div style="background: #005952; color: white; padding: 20px; text-align: center;">
                    <img src="https://files.adventistas.org/v2.adra.org.br/2022/08/22110714/Sem-Titulo-1-2.png" alt="ADRA Logo" style="max-width: 120px; height: auto; border-radius: 8px; margin-bottom: 10px;">
                    <h1 style="font-size: 1.4em; margin: 0; font-weight: bold;">Sistema de Acolhidos</h1>
                    <div style="font-size: 0.8em; opacity: 0.9; margin-top: 5px;">Modo de Emergência</div>
                </div>
                
                <div style="padding: 20px;">
                    <div style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <strong>⚠️ Modo de Emergência</strong><br>
                        Usando senhas padrão do sistema
                    </div>
                    
                    <div class="login-option" onclick="setAccessLevel('portaria'); closeLoginPopup();" 
                         style="background: #f8f9fa; border: 2px solid #005952; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer;">
                        <div style="font-size: 1.5em; margin-bottom: 8px; color: #005952; text-align: center;">
                            <i class="fas fa-door-closed"></i>
                        </div>
                        <div style="font-weight: bold; font-size: 1em; margin-bottom: 5px; color: #2c3e50; text-align: center;">
                            Portaria 
                            <span style="background: #95a5a6; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.7em; font-weight: bold; margin-left: 5px;">VISUALIZAÇÃO</span>
                        </div>
                        <div style="font-size: 0.8em; color: #7f8c8d; line-height: 1.4; text-align: center;">
                            Acesso básico para consulta<br>
                            <small><strong>Senha:</strong> portaria123</small>
                        </div>
                    </div>
                    
                    <div class="login-option" onclick="setMobileTecnicoAccess()" 
                         style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer;">
                        <div style="font-size: 1.5em; margin-bottom: 8px; color: #005952; text-align: center;">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div style="font-weight: bold; font-size: 1em; margin-bottom: 5px; color: #2c3e50; text-align: center;">
                            Técnico 
                            <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.7em; font-weight: bold; margin-left: 5px;">EDIÇÃO</span>
                        </div>
                        <div style="font-size: 0.8em; color: #7f8c8d; line-height: 1.4; text-align: center;">
                            Acesso para técnicos<br>
                            <small><strong>Senha:</strong> tecnico123</small>
                        </div>
                    </div>
                    
                    <div class="login-option" onclick="setMobileAdminAccess()" 
                         style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer;">
                        <div style="font-size: 1.5em; margin-bottom: 8px; color: #005952; text-align: center;">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div style="font-weight: bold; font-size: 1em; margin-bottom: 5px; color: #2c3e50; text-align: center;">
                            Administrador 
                            <span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.7em; font-weight: bold; margin-left: 5px;">TOTAL</span>
                        </div>
                        <div style="font-size: 0.8em; color: #7f8c8d; line-height: 1.4; text-align: center;">
                            Acesso completo<br>
                            <small><strong>Senha:</strong> admin123</small>
                        </div>
                    </div>
                </div>
            `;

            overlay.appendChild(loginContainer);
            document.body.appendChild(overlay);
        }

        // FUNÇÕES MOBILE para acesso
        function setMobileTecnicoAccess() {
            const name = prompt('Digite seu nome de técnico:');
            if (name && name.trim()) {
                currentTecnico = name.trim();
                setAccessLevel('tecnico');
                closeLoginPopup();
            }
        }

        function setMobileAdminAccess() {
            const password = prompt('Digite a senha de administrador:');
            if (password === 'admin123') {
                setAccessLevel('admin');
                closeLoginPopup();
            } else {
                showMessageBox('Senha incorreta. Tente novamente.');
            }
        }

        // FUNÇÃO: Fechar pop-up de login
        function closeLoginPopup() {
            const overlay = document.getElementById('login-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // SISTEMA DE ACESSO
        function setAccessLevel(level) {
            currentAccessLevel = level;
            const badge = document.getElementById('access-badge');
            const btnCadastrar = document.getElementById('btn-cadastrar');
            const btnImportar = document.getElementById('btn-importar');
            const btnLimpar = document.getElementById('btn-limpar');
            const btnSenhas = document.getElementById('btn-senhas');
            
            badge.textContent = level === 'admin' ? 'ADMINISTRADOR' : 
                              level === 'tecnico' ? 'TÉCNICO: ' + currentTecnico : 'PORTARIA';
            badge.className = `access-level-badge access-${level}`;
            
            btnCadastrar.classList.toggle('disabled', level === 'portaria');
            btnImportar.classList.toggle('disabled', level !== 'admin');
            btnLimpar.classList.toggle('disabled', level !== 'admin');
            
            if (btnSenhas) {
                btnSenhas.style.display = level === 'admin' ? 'flex' : 'none';
            }
            
            const welcomeMsg = level === 'admin' ? 'Administrador' : 
                              level === 'tecnico' ? `Técnico ${currentTecnico}` : 'Portaria';
            showMessageBox(`Bem-vindo(a) ao Sistema de Acolhidos ADRA!\n\nNível de acesso: ${welcomeMsg}`);
        }

        function checkAccess(requiredLevel) {
            const levels = { 'portaria': 0, 'tecnico': 1, 'admin': 2 };
            if (levels[currentAccessLevel] < levels[requiredLevel]) {
                showMessageBox('Acesso negado! Você não tem permissão para esta ação.');
                return false;
            }
            return true;
        }

        // FUNÇÕES DO SUPABASE
        async function loadAcolhidos() {
            try {
                updateConnectionStatus('connecting');
                
                const { data, error } = await supabase
                    .from('acolhidos')
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) throw error;

                allAcolhidos = data || [];
                
                const tecnicosSet = new Set();
                allAcolhidos.forEach(a => {
                    if (a.tecnico) tecnicosSet.add(a.tecnico);
                });
                tecnicos = Array.from(tecnicosSet).sort();

                document.getElementById('total-count').textContent = allAcolhidos.length;
                document.getElementById('last-update').textContent = new Date().toLocaleString('pt-BR');
                updateConnectionStatus('connected');
                
            } catch (error) {
                console.error('Erro:', error);
                updateConnectionStatus('error');
                showMessageBox('Erro ao conectar: ' + error.message);
            }
        }

        async function loadMovements() {
            try {
                const { data, error } = await supabase
                    .from('movimentacoes')
                    .select(`*, acolhidos (nome)`)
                    .order('data_hora', { ascending: false });

                if (error) throw error;
                allMovements = data || [];
            } catch (error) {
                console.error('Erro ao carregar movimentações:', error);
            }
        }

        // FUNÇÃO: Verificar status do acolhido (dentro/fora)
        async function getAcolhidoStatus(acolhidoId) {
            try {
                const { data: lastMovement, error } = await supabase
                    .from('movimentacoes')
                    .select('tipo')
                    .eq('acolhido_id', acolhidoId)
                    .order('data_hora', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (!lastMovement || lastMovement.length === 0) {
                    return { status: 'dentro', ultimoMovimento: null };
                }

                const ultimoTipo = lastMovement[0].tipo;
                const status = ultimoTipo === 'entrada' ? 'dentro' : 'fora';
                
                return { status, ultimoMovimento: ultimoTipo };
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                return { status: 'desconhecido', ultimoMovimento: null };
            }
        }

        // FUNÇÕES DA INTERFACE
        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        }

        // FUNÇÃO: Buscar acolhido
        function searchAcolhido() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                showMessageBox('Digite um nome para buscar.');
                return;
            }

            const resultados = allAcolhidos.filter(acolhido => 
                acolhido.nome.toLowerCase().includes(searchTerm)
            );

            displaySearchResults(resultados, searchTerm);
        }

        // FUNÇÃO: Exibir resultados da busca
        function displaySearchResults(resultados, searchTerm) {
            const searchResults = document.getElementById('searchResults');
            
            if (resultados.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-results-card">
                        <div class="acolhido-header">
                            <div>
                                <h3 class="acolhido-name">Nenhum resultado encontrado</h3>
                            </div>
                            <button class="close-results-btn" onclick="closeSearchResults()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="info-section">
                            <div class="info-label">Busca:</div>
                            <div class="info-value">"${searchTerm}"</div>
                        </div>
                        <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                            <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                            Nenhum acolhido encontrado para esta busca.
                        </div>
                    </div>
                `;
            } else {
                let html = '';
                
                resultados.forEach(acolhido => {
                    const restrictionBadge = (acolhido.restricao && acolhido.restricao.trim() !== '') 
                        ? '<span class="restriction-badge-large">RESTRIÇÃO</span>' 
                        : '';
                    
                    html += `
                        <div class="search-results-card" style="margin-bottom: 15px;">
                            <div class="acolhido-header">
                                <div>
                                    <h3 class="acolhido-name">${acolhido.nome}</h3>
                                    ${restrictionBadge}
                                </div>
                                <button class="close-results-btn" onclick="closeSearchResults()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="info-section">
                                <div class="info-label">Data de Entrada:</div>
                                <div class="info-value">${formatDate(acolhido.data_de_entrada)}</div>
                            </div>

                            <div class="info-section">
                                <div class="info-label">Telefone:</div>
                                <div class="info-value">${acolhido.telefone || 'Não informado'}</div>
                            </div>

                            <div class="info-section">
                                <div class="info-label">Técnico Responsável:</div>
                                <div class="info-value">${acolhido.tecnico || 'Não atribuído'}</div>
                            </div>

                            <div class="info-section">
                                <div class="info-label">Observações:</div>
                                <div class="info-value">${acolhido.obs || 'Nenhuma observação'}</div>
                            </div>

                            ${acolhido.restricao ? `
                            <div class="info-section restriction-section">
                                <div class="info-label">Restrições:</div>
                                <div class="info-value">${acolhido.restricao}</div>
                            </div>
                            ` : ''}

                            <div class="action-buttons-search">
                                <button class="print-btn-search" onclick="printAcolhido('${acolhido.id}')">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                                ${canEditAcolhido(acolhido) ? `
                                <button class="edit-btn-search" onclick="editAcolhido('${acolhido.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="transfer-btn-search" onclick="transferirAcolhido('${acolhido.id}')">
                                    <i class="fas fa-exchange-alt"></i> Transferir
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                if (resultados.length > 1) {
                    html = `
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                            <strong>${resultados.length} acolhido(s) encontrado(s) para: "${searchTerm}"</strong>
                        </div>
                    ` + html;
                }

                searchResults.innerHTML = html;
            }
            
            searchResults.style.display = 'block';
            searchResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // FUNÇÃO: Fechar resultados da busca
        function closeSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
        }

        // FUNÇÃO: Autocomplete na busca
        function setupSearchAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('autocompleteSuggestions');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                
                if (searchTerm.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                const suggestions = allAcolhidos.filter(acolhido => 
                    acolhido.nome.toLowerCase().includes(searchTerm)
                ).slice(0, 8);
                
                displayAutocompleteSuggestions(suggestions, searchTerm);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        // FUNÇÃO: Exibir sugestões de autocomplete
        function displayAutocompleteSuggestions(suggestions, searchTerm) {
            const suggestionsContainer = document.getElementById('autocompleteSuggestions');
            
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            let html = '';
            
            suggestions.forEach(acolhido => {
                const restrictionBadge = (acolhido.restricao && acolhido.restricao.trim() !== '') 
                    ? '<span class="autocomplete-restriction">R</span>' 
                    : '';
                
                const nome = acolhido.nome;
                const termIndex = nome.toLowerCase().indexOf(searchTerm);
                const highlightedName = termIndex >= 0 
                    ? nome.substring(0, termIndex) + 
                      '<strong>' + nome.substring(termIndex, termIndex + searchTerm.length) + '</strong>' + 
                      nome.substring(termIndex + searchTerm.length)
                    : nome;
                
                html += `
                    <div class="autocomplete-item" onclick="selectAutocompleteSuggestion('${acolhido.id}')">
                        <div>
                            <div>${highlightedName}</div>
                            <small style="color: #7f8c8d;">${acolhido.tecnico || 'Sem técnico'}</small>
                        </div>
                        ${restrictionBadge}
                    </div>
                `;
            });
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.style.display = 'block';
        }

        // FUNÇÃO: Selecionar sugestão do autocomplete
        function selectAutocompleteSuggestion(acolhidoId) {
            const acolhido = allAcolhidos.find(a => a.id === acolhidoId);
            if (!acolhido) return;
            
            document.getElementById('searchInput').value = acolhido.nome;
            document.getElementById('autocompleteSuggestions').style.display = 'none';
            displaySearchResults([acolhido], acolhido.nome);
        }

        // FUNÇÃO: Buscar ao pressionar Enter
        function setupSearchEnterKey() {
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAcolhido();
                }
            });
        }

        function showTechnicians() {
            if (tecnicos.length === 0) {
                showMessageBox("Nenhum técnico cadastrado.");
                return;
            }
            showMessageBox("Técnicos:\n\n" + tecnicos.join("\n"));
        }

        function showReports() {
            if (!allAcolhidos.length) {
                showMessageBox("Nenhum dado carregado.");
                return;
            }

            mainContent.innerHTML = '<h2>📊 Relatórios</h2>';
            let hasObs = false;

            allAcolhidos.forEach(a => {
                if (a.obs && a.obs.trim() !== '') {
                    hasObs = true;
                    const div = document.createElement('div');
                    div.style.background = 'white';
                    div.style.padding = '15px';
                    div.style.marginBottom = '10px';
                    div.style.borderLeft = '5px solid #27ae60';
                    div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    
                    const restrictionBadge = (a.restricao && a.restricao.trim() !== '') 
                        ? '<span class="restriction-badge-large" style="font-size: 0.8em; padding: 4px 8px; margin-left: 10px;">RESTRIÇÃO</span>' 
                        : '';
                    div.innerHTML = `<strong>Nome:</strong> ${a.nome}${restrictionBadge}<br><strong>Observação:</strong> ${a.obs}`;
                    mainContent.appendChild(div);
                }
            });

            if (!hasObs) {
                mainContent.innerHTML += '<p style="text-align: center;">Nenhuma observação encontrada.</p>';
            }
        }

        function showRestricted() {
            if (!allAcolhidos.length) {
                showMessageBox("Nenhum dado carregado.");
                return;
            }

            mainContent.innerHTML = '<h2>🚧 Acolhidos Restritos</h2>';
            let hasRestriction = false;

            allAcolhidos.forEach(a => {
                if (a.restricao && a.restricao.trim() !== '') {
                    hasRestriction = true;
                    const div = document.createElement('div');
                    div.style.background = 'white';
                    div.style.padding = '15px';
                    div.style.marginBottom = '10px';
                    div.style.borderLeft = '5px solid #e74c3c';
                    div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    div.innerHTML = `<strong>Nome:</strong> ${a.nome}<br><strong>Restrição:</strong> ${a.restricao}`;
                    mainContent.appendChild(div);
                }
            });

            if (!hasRestriction) {
                mainContent.innerHTML += '<p style="text-align: center;">Nenhuma restrição encontrada.</p>';
            }
        }

        function showAllData() {
            if (!allAcolhidos.length) {
                showMessageBox("Nenhum dado carregado.");
                return;
            }
            renderCollapsibleContent();
        }

        function renderCollapsibleContent() {
            mainContent.innerHTML = '<h2>📋 Dados dos Acolhidos</h2>';
            
            let dataToShow = [...allAcolhidos];
            
            if (currentAccessLevel === 'tecnico') {
                dataToShow = dataToShow.filter(a => a.tecnico === currentTecnico);
            }
            
            const grouped = {};
            dataToShow.forEach(a => {
                const tec = a.tecnico || 'Sem Técnico';
                if (!grouped[tec]) grouped[tec] = [];
                grouped[tec].push(a);
            });

            const tecnicosList = Object.keys(grouped).sort();
            
            if (tecnicosList.length === 0) {
                mainContent.innerHTML += '<p style="text-align: center;">Nenhum acolhido encontrado.</p>';
                return;
            }

            tecnicosList.forEach(tecnico => {
                const button = document.createElement('button');
                button.className = 'collapsible';
                button.textContent = `${tecnico} (${grouped[tecnico].length})`;
                mainContent.appendChild(button);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'collapsible-content';

                grouped[tecnico].forEach(a => {
                    const canEdit = canEditAcolhido(a);
                    const p = document.createElement('p');
                    
                    const restrictionBadge = (a.restricao && a.restricao.trim() !== '') 
                        ? '<span class="restriction-badge-large" style="font-size: 0.8em; padding: 4px 8px; margin-left: 10px;">RESTRIÇÃO</span>' 
                        : '';
                    
                    p.innerHTML = `
                        <strong>Nome:</strong> ${a.nome}${restrictionBadge}<br>
                        <strong>Data de Entrada:</strong> ${formatDate(a.data_de_entrada)}<br>
                        <strong>Telefone:</strong> ${a.telefone || 'N/A'}<br>
                        <strong>Obs:</strong> ${a.obs || 'N/A'}<br>
                        <strong>Restrição:</strong> ${a.restricao || 'N/A'}<br>
                        <div class="action-buttons">
                            <button class="print-btn" onclick="printAcolhido('${a.id}')"><i class="fas fa-print"></i> Imprimir</button>
                            ${canEdit ? `<button class="edit-btn" onclick="editAcolhido('${a.id}')"><i class="fas fa-edit"></i> Editar</button>` : ''}
                            ${canEdit ? `<button class="transfer-btn" onclick="transferirAcolhido('${a.id}')"><i class="fas fa-exchange-alt"></i> Transferir</button>` : ''}
                            ${currentAccessLevel === 'admin' ? `<button class="delete-btn" onclick="deleteAcolhido('${a.id}')"><i class="fas fa-trash"></i> Remover</button>` : ''}
                        </div>
                    `;
                    contentDiv.appendChild(p);
                });
                mainContent.appendChild(contentDiv);
            });

            document.querySelectorAll('.collapsible').forEach(button => {
                button.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                });
            });
        }

        function canEditAcolhido(acolhido) {
            if (currentAccessLevel === 'admin') return true;
            if (currentAccessLevel === 'tecnico' && acolhido.tecnico === currentTecnico) return true;
            return false;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // FUNÇÃO: Cadastrar acolhido - CORRIGIDA
        function showRegisterForm() {
            if (!checkAccess('tecnico')) return;
            
            const selectOptions = tecnicos.map(t => `<option value="${t}">${t}</option>`).join('');
            
            mainContent.innerHTML = `
                <h2>📋 Cadastro de Acolhido</h2>
                <div class="registration-form">
                    <label>Técnico:</label>
                    <select id="tecnico" ${currentAccessLevel === 'tecnico' ? 'disabled' : ''}>
                        <option value="">-- Selecione --</option>
                        ${selectOptions}
                        ${currentAccessLevel === 'admin' ? '<option value="novo">-- Adicionar Novo --</option>' : ''}
                    </select>
                    <input type="text" id="new-tecnico" placeholder="Nome do novo técnico" style="display:none; margin-top:10px;">
                    
                    <label>Nome:</label>
                    <input type="text" id="nome" required>

                    <label>Data de Entrada:</label>
                    <input type="date" id="data_de_entrada">

                    <label>Telefone:</label>
                    <input type="text" id="telefone">

                    <label>Obs:</label>
                    <textarea id="obs" rows="3"></textarea>

                    <label>Restrição:</label>
                    <input type="text" id="restricao">

                    <button onclick="saveAcolhido()">Salvar Registro</button>
                </div>
            `;

            if (currentAccessLevel === 'tecnico') {
                document.getElementById('tecnico').value = currentTecnico;
            }

            if (currentAccessLevel === 'admin') {
                document.getElementById('tecnico').addEventListener('change', (e) => {
                    const newInput = document.getElementById('new-tecnico');
                    newInput.style.display = e.target.value === 'novo' ? 'block' : 'none';
                });
            }
        }

        // FUNÇÃO: Cadastrar acolhido - CORRIGIDA (SEM created_at)
        async function saveAcolhido() {
            let tecnico = document.getElementById('tecnico').value;
            if (tecnico === 'novo') {
                tecnico = document.getElementById('new-tecnico').value.trim();
                if (!tecnico) {
                    showMessageBox('Digite o nome do novo técnico.');
                    return;
                }
            }

            if (currentAccessLevel === 'tecnico') {
                tecnico = currentTecnico;
            }

            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                showMessageBox('O nome é obrigatório.');
                return;
            }

            const newAcolhido = {
                nome: nome,
                data_de_entrada: document.getElementById('data_de_entrada').value || null,
                telefone: document.getElementById('telefone').value.trim() || null,
                obs: document.getElementById('obs').value.trim() || null,
                restricao: document.getElementById('restricao').value.trim() || null,
                tecnico: tecnico || null
                // REMOVIDO: created_at - coluna já existe e é gerenciada automaticamente pelo Supabase
            };

            try {
                const { error } = await supabase
                    .from('acolhidos')
                    .insert([newAcolhido]);

                if (error) throw error;

                showMessageBox('Registro salvo com sucesso!');
                showRegisterForm();
                loadAcolhidos();
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao salvar: ' + error.message);
            }
        }

        // FUNÇÃO: Editar acolhido
        async function editAcolhido(id) {
            const acolhido = allAcolhidos.find(a => a.id === id);
            if (!acolhido) {
                showMessageBox('Acolhido não encontrado.');
                return;
            }

            if (!canEditAcolhido(acolhido)) {
                showMessageBox('Você não tem permissão para editar este acolhido.');
                return;
            }

            const selectOptions = tecnicos.map(t => `<option value="${t}" ${t === acolhido.tecnico ? 'selected' : ''}>${t}</option>`).join('');
            
            mainContent.innerHTML = `
                <h2>✏️ Editar Acolhido</h2>
                <div class="registration-form">
                    <label>Técnico:</label>
                    <select id="tecnico" ${currentAccessLevel === 'tecnico' ? 'disabled' : ''}>
                        <option value="">-- Selecione --</option>
                        ${selectOptions}
                        ${currentAccessLevel === 'admin' ? '<option value="novo">-- Adicionar Novo --</option>' : ''}
                    </select>
                    <input type="text" id="new-tecnico" placeholder="Nome do novo técnico" style="display:none; margin-top:10px;">
                    
                    <label>Nome:</label>
                    <input type="text" id="nome" value="${acolhido.nome || ''}" required>

                    <label>Data de Entrada:</label>
                    <input type="date" id="data_de_entrada" value="${acolhido.data_de_entrada || ''}">

                    <label>Telefone:</label>
                    <input type="text" id="telefone" value="${acolhido.telefone || ''}">

                    <label>Obs:</label>
                    <textarea id="obs" rows="3">${acolhido.obs || ''}</textarea>

                    <label>Restrição:</label>
                    <input type="text" id="restricao" value="${acolhido.restricao || ''}">

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="updateAcolhido('${id}')" style="background: #27ae60; flex: 1;">Salvar Alterações</button>
                        <button onclick="showAllData()" style="background: #95a5a6; flex: 1;">Cancelar</button>
                    </div>
                </div>
            `;

            if (currentAccessLevel === 'tecnico') {
                document.getElementById('tecnico').value = currentTecnico;
            }

            if (currentAccessLevel === 'admin') {
                document.getElementById('tecnico').addEventListener('change', (e) => {
                    const newInput = document.getElementById('new-tecnico');
                    newInput.style.display = e.target.value === 'novo' ? 'block' : 'none';
                });
            }
        }

        // FUNÇÃO: Atualizar acolhido - CORRIGIDA
        async function updateAcolhido(id) {
            let tecnico = document.getElementById('tecnico').value;
            if (tecnico === 'novo') {
                tecnico = document.getElementById('new-tecnico').value.trim();
                if (!tecnico) {
                    showMessageBox('Digite o nome do novo técnico.');
                    return;
                }
            }

            if (currentAccessLevel === 'tecnico') {
                tecnico = currentTecnico;
            }

            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                showMessageBox('O nome é obrigatório.');
                return;
            }

            const updatedAcolhido = {
                nome: nome,
                data_de_entrada: document.getElementById('data_de_entrada').value || null,
                telefone: document.getElementById('telefone').value.trim() || null,
                obs: document.getElementById('obs').value.trim() || null,
                restricao: document.getElementById('restricao').value.trim() || null,
                tecnico: tecnico || null
                // REMOVIDO: updated_at - coluna não existe
            };

            try {
                const { error } = await supabase
                    .from('acolhidos')
                    .update(updatedAcolhido)
                    .eq('id', id);

                if (error) throw error;

                showMessageBox('Registro atualizado com sucesso!');
                loadAcolhidos();
                showAllData();
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao atualizar: ' + error.message);
            }
        }

        // FUNÇÃO: Transferir acolhido para outro técnico - CORRIGIDA
        async function transferirAcolhido(acolhidoId) {
            const acolhido = allAcolhidos.find(a => a.id === acolhidoId);
            if (!acolhido) {
                showMessageBox('Acolhido não encontrado.');
                return;
            }

            if (!canEditAcolhido(acolhido)) {
                showMessageBox('Você não tem permissão para transferir este acolhido.');
                return;
            }

            // Criar pop-up para selecionar novo técnico
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            // Obter lista de técnicos disponíveis (excluindo o atual)
            const tecnicosDisponiveis = tecnicos.filter(t => t !== acolhido.tecnico);
            
            let html = `
                <h3>🔄 Transferir Acolhido</h3>
                <div class="registration-form" style="margin: 15px 0; border: none; background: #f8f9fa;">
                    <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                        <strong>Transferindo acolhido:</strong> ${acolhido.nome}<br>
                        <strong>Técnico atual:</strong> ${acolhido.tecnico || 'Não atribuído'}
                    </div>

                    <label>Selecione o novo técnico:</label>
                    <select id="novo-tecnico" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">
                        <option value="">-- Selecione um técnico --</option>
                        ${tecnicosDisponiveis.map(t => `<option value="${t}">${t}</option>`).join('')}
                        <option value="novo">-- Adicionar Novo Técnico --</option>
                    </select>
                    
                    <input type="text" id="novo-tecnico-nome" placeholder="Nome do novo técnico" 
                           style="display:none; width: 100%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #bdc3c7;">

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="confirmarTransferencia('${acolhidoId}')" 
                                style="background: #9b59b6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold;">
                            <i class="fas fa-exchange-alt"></i> Transferir
                        </button>
                        <button onclick="closeDataPopup()" 
                                style="background: #95a5a6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            popupContent.innerHTML = html;
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            // Configurar evento para mostrar campo de novo técnico
            document.getElementById('novo-tecnico').addEventListener('change', (e) => {
                const novoInput = document.getElementById('novo-tecnico-nome');
                novoInput.style.display = e.target.value === 'novo' ? 'block' : 'none';
            });
        }

        // FUNÇÃO: Confirmar transferência - CORRIGIDA (SEM updated_at)
        async function confirmarTransferencia(acolhidoId) {
            const acolhido = allAcolhidos.find(a => a.id === acolhidoId);
            if (!acolhido) {
                showMessageBox('Acolhido não encontrado.');
                return;
            }

            let novoTecnico = document.getElementById('novo-tecnico').value;
            
            if (novoTecnico === 'novo') {
                novoTecnico = document.getElementById('novo-tecnico-nome').value.trim();
                if (!novoTecnico) {
                    showMessageBox('Digite o nome do novo técnico.');
                    return;
                }
            }
            
            if (!novoTecnico) {
                showMessageBox('Selecione um técnico.');
                return;
            }
            
            if (novoTecnico === acolhido.tecnico) {
                showMessageBox('O acolhido já está com este técnico.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('acolhidos')
                    .update({ 
                        tecnico: novoTecnico
                        // REMOVIDO: updated_at - não é necessário enviar, o Supabase gerencia automaticamente se a coluna existir
                    })
                    .eq('id', acolhidoId);

                if (error) throw error;

                showMessageBox(`✅ Acolhido transferido com sucesso!\n\n${acolhido.nome}\nDe: ${acolhido.tecnico || 'N/A'}\nPara: ${novoTecnico}`);
                
                // Atualizar dados
                loadAcolhidos();
                
                // Fechar pop-up e atualizar visualização
                closeDataPopup();
                
                // Se estiver na visualização de dados, recarregar
                if (document.getElementById('mainContent').innerHTML.includes('Dados dos Acolhidos')) {
                    showAllData();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao transferir acolhido: ' + error.message);
            }
        }

        // FUNÇÕES AUXILIARES
        function showMessageBox(message, type = 'alert') {
            return new Promise((resolve) => {
                document.getElementById('messageText').textContent = message;
                const okBtn = document.getElementById('alert-ok-btn');
                const confirmOkBtn = document.getElementById('confirm-ok-btn');
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                okBtn.style.display = 'none';
                confirmOkBtn.style.display = 'none';
                confirmCancelBtn.style.display = 'none';

                if (type === 'alert') {
                    okBtn.style.display = 'inline-block';
                    okBtn.onclick = () => {
                        closeMessageBox();
                        resolve(true);
                    };
                } else if (type === 'confirm') {
                    confirmOkBtn.style.display = 'inline-block';
                    confirmCancelBtn.style.display = 'inline-block';
                    confirmOkBtn.onclick = () => {
                        closeMessageBox();
                        resolve(true);
                    };
                    confirmCancelBtn.onclick = () => {
                        closeMessageBox();
                        resolve(false);
                    };
                }
                document.getElementById('messageBox').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function updateConnectionStatus(status) {
            const elem = document.getElementById('connection-status');
            elem.className = 'connection-status';
            if (status === 'connected') {
                elem.classList.add('status-connected');
                elem.textContent = '✓ Conectado';
            } else if (status === 'connecting') {
                elem.classList.add('status-connecting');
                elem.textContent = '⟳ Conectando...';
            } else {
                elem.classList.add('status-error');
                elem.textContent = '✗ Erro';
            }
        }

        function showAcronyms() {
            showMessageBox(`Legenda de Siglas:

DSO: Desorganizado
UD: Uso de drogas
UA: Uso de álcool
MC: Machucado
UP: Uso de palavrão
AGF: Agressão física
FB: Fora do Abrigo`);
        }

        function logout() {
            if (confirm('Deseja realmente sair e trocar de usuário?')) {
                location.reload();
            }
        }

        function refreshData() {
            loadAcolhidos();
            loadMovements();
            showMessageBox('Dados atualizados com sucesso!');
        }

        // FUNÇÃO IMPRIMIR
        async function printAcolhido(id) {
            const acolhido = allAcolhidos.find(a => a.id === id);
            if (!acolhido) {
                showMessageBox('Acolhido não encontrado.');
                return;
            }

            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Ficha do Acolhido - ${acolhido.nome}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #005952; text-align: center; }
                            .info { margin: 10px 0; padding: 10px; border-left: 4px solid #27ae60; background: #f8f9fa; }
                            .restricao { border-left-color: #e74c3c; background: #f8d7da; }
                            button { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>Ficha do Acolhido</h1>
                        <div class="info">
                            <strong>Nome:</strong> ${acolhido.nome}
                        </div>
                        <div class="info">
                            <strong>Data Entrada:</strong> ${acolhido.data_de_entrada || 'N/A'}
                        </div>
                        <div class="info">
                            <strong>Telefone:</strong> ${acolhido.telefone || 'N/A'}
                        </div>
                        <div class="info">
                            <strong>Observações:</strong> ${acolhido.obs || 'N/A'}
                        </div>
                        <div class="info ${acolhido.restricao ? 'restricao' : ''}">
                            <strong>Restrição:</strong> ${acolhido.restricao || 'N/A'}
                        </div>
                        <div style="text-align: center;">
                            <button onclick="window.print()">Imprimir</button>
                            <button onclick="window.close()">Fechar</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // FUNÇÃO REMOVER
        async function deleteAcolhido(id) {
            if (!checkAccess('admin')) return;
            
            const confirmar = await showMessageBox(
                'Tem certeza que deseja remover este acolhido?',
                'confirm'
            );
            
            if (confirmar) {
                try {
                    const { error } = await supabase
                        .from('acolhidos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    showMessageBox('Acolhido removido com sucesso!');
                    loadAcolhidos();
                    showAllData();
                } catch (error) {
                    console.error('Erro:', error);
                    showMessageBox('Erro ao remover: ' + error.message);
                }
            }
        }

        async function clearAllData() {
            if (!checkAccess('admin')) return;
            
            const confirm1 = await showMessageBox(
                'ATENÇÃO: Esta ação vai APAGAR PERMANENTEMENTE todos os acolhidos!\n\nTem certeza?',
                'confirm'
            );
            if (!confirm1) return;

            const confirm2 = await showMessageBox(
                'CONFIRMAÇÃO FINAL:\n\nTodos os dados serão perdidos!\n\nDeseja realmente prosseguir?',
                'confirm'
            );
            if (!confirm2) return;

            try {
                const { error } = await supabase
                    .from('acolhidos')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (error) throw error;

                allAcolhidos = [];
                tecnicos = [];
                document.getElementById('total-count').textContent = '0';
                
                showMessageBox('Todos os dados foram apagados!');
                mainContent.innerHTML = '<h2>Sistema Limpo</h2><p style="text-align: center; color: #7f8c8d;">Todos os dados foram removidos.</p>';
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao apagar: ' + error.message);
            }
        }

        // =============================================
        // FUNÇÕES ATUALIZADAS - ENTRADA/SAÍDA EM POP-UP
        // =============================================

        // FUNÇÃO: Entrada/Saída - ATUALIZADA COM STATUS
        function showEntryExitPanel() {
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            
            let html = `
                <h3>🚪 Painel de Entrada e Saída</h3>
                <div class="registration-form" style="margin: 15px 0; border: none; background: #f8f9fa;">
                    <label>Selecione o Acolhido:</label>
                    <select id="movement-acolhido" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;" onchange="updateAcolhidoInfo()">
                        <option value="">-- Selecione --</option>
                        ${allAcolhidos.map(a => `<option value="${a.id}">${a.nome}</option>`).join('')}
                    </select>

                    <div id="acolhido-info" style="display: none; margin: 15px 0;">
                    </div>

                    <label>Tipo de Movimento:</label>
                    <select id="movement-type" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">
                        <option value="saida">Saída</option>
                        <option value="entrada">Entrada (Retorno)</option>
                    </select>

                    <label>Data e Hora:</label>
                    <input type="datetime-local" id="movement-datetime" value="${currentDateTime}" 
                           style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">

                    <label>Observação:</label>
                    <textarea id="movement-obs" rows="3" placeholder="Motivo da saída ou observações sobre o retorno"
                              style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;"></textarea>

                    <button onclick="saveMovementFromPopup()" 
                            style="background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px;">
                        Registrar Movimento
                    </button>
                    
                    <button onclick="showMovementHistory()" 
                            style="background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px;">
                        <i class="fas fa-history"></i> Ver Histórico de Movimentações
                    </button>
                </div>
                
                <div id="movement-history-container" style="display: none; margin-top: 15px;">
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="close-popup" onclick="closeDataPopup()">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            `;
            
            popupContent.innerHTML = html;
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        // FUNÇÃO: Atualizar informações do acolhido selecionado - ATUALIZADA COM STATUS
        async function updateAcolhidoInfo() {
            const acolhidoId = document.getElementById('movement-acolhido').value;
            const infoDiv = document.getElementById('acolhido-info');
            
            if (!acolhidoId) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const acolhido = allAcolhidos.find(a => a.id === acolhidoId);
            if (!acolhido) {
                infoDiv.style.display = 'none';
                return;
            }
            
            infoDiv.style.display = 'block';
            
            const statusInfo = await getAcolhidoStatus(acolhidoId);
            const statusBadge = statusInfo.status === 'dentro' ? 
                '<span style="background: #27ae60; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold;">✅ DENTRO DO ABRIGO</span>' :
                '<span style="background: #e74c3c; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold;">🚪 FORA DO ABRIGO</span>';
            
            let restrictionsHtml = '';
            if (acolhido.restricao && acolhido.restricao.trim() !== '') {
                restrictionsHtml = `
                    <div style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 5px; border-left: 4px solid #ffc107; margin-top: 10px;">
                        <strong>⚠️ ATENÇÃO - RESTRIÇÕES:</strong><br>
                        ${acolhido.restricao}
                    </div>
                `;
            }
            
            let saidasHtml = '';
            try {
                const hoje = new Date().toISOString().split('T')[0];
                
                const { data: saidasHoje, error } = await supabase
                    .from('movimentacoes')
                    .select('*')
                    .eq('acolhido_id', acolhidoId)
                    .eq('tipo', 'saida')
                    .gte('data_hora', hoje + 'T00:00:00')
                    .lte('data_hora', hoje + 'T23:59:59');
                
                if (error) throw error;
                
                const totalSaidas = saidasHoje ? saidasHoje.length : 0;
                
                saidasHtml = `
                    <div style="background: #e8f4fd; color: #004085; padding: 10px; border-radius: 5px; border-left: 4px solid #3498db; margin-top: 10px;">
                        <strong>📊 Saídas registradas hoje:</strong> ${totalSaidas}
                        ${totalSaidas > 0 ? `<br><small>Última saída: ${formatDateTime(saidasHoje[0].data_hora)}</small>` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao contar saídas:', error);
                saidasHtml = `
                    <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>Erro ao carregar contador de saídas</strong>
                    </div>
                `;
            }
            
            infoDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #2c3e50;">${acolhido.nome}</strong>
                        ${statusBadge}
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">
                        <strong>Técnico:</strong> ${acolhido.tecnico || 'Não atribuído'}<br>
                        <strong>Status:</strong> ${statusInfo.status.toUpperCase()} 
                        ${statusInfo.ultimoMovimento ? `(Último: ${statusInfo.ultimoMovimento})` : ''}
                    </div>
                    ${restrictionsHtml}
                    ${saidasHtml}
                </div>
            `;
        }

        // FUNÇÃO: Salvar movimento a partir da pop-up - ATUALIZADA COM VERIFICAÇÃO DE ELEMENTO
        async function saveMovementFromPopup() {
            const acolhidoId = document.getElementById('movement-acolhido').value;
            const tipo = document.getElementById('movement-type').value;
            const dataHora = document.getElementById('movement-datetime').value;
            const obs = document.getElementById('movement-obs').value.trim();

            if (!acolhidoId) {
                showMessageBox('Selecione um acolhido.');
                return;
            }

            if (!dataHora) {
                showMessageBox('Informe a data e hora.');
                return;
            }

            const acolhido = allAcolhidos.find(a => a.id === acolhidoId);
            if (!acolhido) {
                showMessageBox('Acolhido não encontrado.');
                return;
            }

            const newMovement = {
                acolhido_id: acolhidoId,
                tipo: tipo,
                data_hora: new Date(dataHora).toISOString(),
                observacao: obs || 'Sem observação',
                tecnico_responsavel: acolhido.tecnico || null
            };

            try {
                const { data, error } = await supabase
                    .from('movimentacoes')
                    .insert([newMovement])
                    .select();

                if (error) throw error;

                showMessageBox('Movimento registrado com sucesso!');
                
                document.getElementById('movement-acolhido').value = '';
                document.getElementById('movement-obs').value = '';
                document.getElementById('movement-datetime').value = new Date().toISOString().slice(0, 16);
                
                document.getElementById('acolhido-info').style.display = 'none';
                
                // VERIFICAÇÃO CORRIGIDA: Atualizar histórico se estiver visível
                const historyContainer = document.getElementById('movement-history-container');
                if (historyContainer && historyContainer.style.display === 'block') {
                    showMovementHistory();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao registrar movimento: ' + error.message);
            }
        }

        // FUNÇÃO: Mostrar histórico de movimentações - CORRIGIDA COM VERIFICAÇÃO DE ELEMENTO
        async function showMovementHistory() {
            const container = document.getElementById('movement-history-container');
            
            // VERIFICAÇÃO ADICIONADA: Se o container não existe, não fazer nada
            if (!container) {
                console.error('Elemento movement-history-container não encontrado');
                return;
            }
            
            // Se já está visível, ocultar
            if (container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }
            
            // Resto do código permanece o mesmo...
            container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Carregando histórico...</p>';
            container.style.display = 'block';
            
            try {
                // Carregar movimentações do Supabase COM JOIN
                const { data: movements, error } = await supabase
                    .from('movimentacoes')
                    .select(`*, acolhidos (nome)`)
                    .order('data_hora', { ascending: false });

                if (error) throw error;

                allMovements = movements || [];
                
                if (allMovements.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nenhuma movimentação registrada.</p>';
                    return;
                }
                
                // Renderizar histórico
                let historyHtml = '<h4 style="color: #005952; margin-bottom: 10px;">📋 Histórico de Movimentações</h4>';
                
                allMovements.forEach(mov => {
                    // Usar nome do acolhido do JOIN
                    const acolhidoNome = mov.acolhidos?.nome || 'Nome não encontrado';
                    
                    const icon = mov.tipo === 'saida' ? '🚪 SAÍDA' : '🏠 ENTRADA';
                    const borderColor = mov.tipo === 'saida' ? '#e67e22' : '#27ae60';
                    
                    // BOTÕES DE AÇÃO - APENAS PARA ADMIN
                    const actionButtons = currentAccessLevel === 'admin' ? `
                        <div class="movement-actions" style="margin-top: 8px;">
                            <button class="edit-movement-btn" onclick="editMovement('${mov.id}')" 
                                    style="background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="delete-movement-btn" onclick="deleteMovement('${mov.id}')" 
                                    style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em;">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                    ` : '';
                    
                    historyHtml += `
                        <div class="movement-record" style="background: white; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong>${icon} - ${acolhidoNome}</strong><br>
                            <strong>Data/Hora:</strong> ${formatDateTime(mov.data_hora)}<br>
                            <strong>Observação:</strong> ${mov.observacao || 'Sem observação'}<br>
                            ${mov.tecnico_responsavel ? `<strong>Técnico:</strong> ${mov.tecnico_responsavel}<br>` : ''}
                            <small style="color: #7f8c8d;">ID: ${mov.id}</small>
                            ${actionButtons}
                        </div>
                    `;
                });
                
                container.innerHTML = historyHtml;
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                if (container) {
                    container.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erro ao carregar histórico.</p>';
                }
            }
        }

        // FUNÇÃO: Editar movimentação (APENAS ADMIN)
        async function editMovement(movementId) {
            if (!checkAccess('admin')) {
                showMessageBox('Apenas administradores podem editar movimentações.');
                return;
            }
            
            try {
                // Buscar dados da movimentação
                const { data: movement, error } = await supabase
                    .from('movimentacoes')
                    .select('*, acolhidos (nome)')
                    .eq('id', movementId)
                    .single();
                    
                if (error) throw error;
                
                if (!movement) {
                    showMessageBox('Movimentação não encontrada.');
                    return;
                }
                
                // Criar pop-up de edição
                const popupContent = document.getElementById('popupContent');
                const dataPopup = document.getElementById('dataPopup');
                
                // Formatar data/hora para o input datetime-local
                const movementDateTime = new Date(movement.data_hora);
                const formattedDateTime = movementDateTime.toISOString().slice(0, 16);
                
                const html = `
                    <h3>✏️ Editar Movimentação</h3>
                    <div class="registration-form" style="margin: 15px 0; border: none; background: #f8f9fa;">
                        <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                            <strong>Editando movimentação de:</strong> ${movement.acolhidos?.nome || 'N/A'}<br>
                            <strong>ID:</strong> ${movement.id}
                        </div>

                        <label>Acolhido:</label>
                        <input type="text" value="${movement.acolhidos?.nome || 'N/A'}" disabled 
                               style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; background: #e9ecef;">

                        <label>Tipo de Movimento:</label>
                        <select id="edit-movement-type" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <option value="saida" ${movement.tipo === 'saida' ? 'selected' : ''}>Saída</option>
                            <option value="entrada" ${movement.tipo === 'entrada' ? 'selected' : ''}>Entrada (Retorno)</option>
                        </select>

                        <label>Data e Hora:</label>
                        <input type="datetime-local" id="edit-movement-datetime" value="${formattedDateTime}" 
                               style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">

                        <label>Observação:</label>
                        <textarea id="edit-movement-obs" rows="3" placeholder="Observações sobre a movimentação"
                                  style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">${movement.observacao || ''}</textarea>

                        <label>Técnico Responsável:</label>
                        <input type="text" id="edit-movement-tecnico" value="${movement.tecnico_responsavel || ''}" 
                               placeholder="Nome do técnico responsável"
                               style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="updateMovement('${movementId}')" 
                                    style="background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold;">
                                <i class="fas fa-save"></i> Atualizar
                            </button>
                            <button onclick="closeDataPopup()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                popupContent.innerHTML = html;
                dataPopup.style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar movimentação:', error);
                showMessageBox('Erro ao carregar dados da movimentação: ' + error.message);
            }
        }

        // FUNÇÃO: Atualizar movimentação - CORRIGIDA COM VERIFICAÇÃO DE ELEMENTO
        async function updateMovement(movementId) {
            if (!checkAccess('admin')) {
                showMessageBox('Apenas administradores podem editar movimentações.');
                return;
            }
            
            const tipo = document.getElementById('edit-movement-type').value;
            const dataHora = document.getElementById('edit-movement-datetime').value;
            const obs = document.getElementById('edit-movement-obs').value.trim();
            const tecnico = document.getElementById('edit-movement-tecnico').value.trim();

            if (!dataHora) {
                showMessageBox('Informe a data e hora.');
                return;
            }

            const updatedMovement = {
                tipo: tipo,
                data_hora: new Date(dataHora).toISOString(),
                observacao: obs || 'Sem observação',
                tecnico_responsavel: tecnico || null,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('movimentacoes')
                    .update(updatedMovement)
                    .eq('id', movementId);

                if (error) throw error;

                showMessageBox('Movimentação atualizada com sucesso!');
                closeDataPopup();
                
                // VERIFICAÇÃO CORRIGIDA: Recarregar histórico se estiver visível
                const historyContainer = document.getElementById('movement-history-container');
                if (historyContainer && historyContainer.style.display === 'block') {
                    showMovementHistory();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao atualizar movimentação: ' + error.message);
            }
        }

        // FUNÇÃO: Excluir movimentação (APENAS ADMIN)
        async function deleteMovement(movementId) {
            if (!checkAccess('admin')) {
                showMessageBox('Apenas administradores podem remover movimentações.');
                return;
            }
            
            const confirmar = await showMessageBox(
                'Tem certeza que deseja excluir esta movimentação?\n\nEsta ação não pode ser desfeita.',
                'confirm'
            );
            
            if (!confirmar) return;

            try {
                const { error } = await supabase
                    .from('movimentacoes')
                    .delete()
                    .eq('id', movementId);

                if (error) throw error;

                showMessageBox('Movimentação excluída com sucesso!');
                
                // Recarregar histórico se estiver visível
                const historyContainer = document.getElementById('movement-history-container');
                if (historyContainer && historyContainer.style.display === 'block') {
                    showMovementHistory();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showMessageBox('Erro ao excluir movimentação: ' + error.message);
            }
        }

        // FUNÇÃO: Formatar data/hora para exibição
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // FUNÇÃO: Importar Excel - COMPLETA
        async function importExcel() {
            if (!checkAccess('admin')) return;
            
            // Criar interface de importação
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            const html = `
                <h3>📤 Importar Dados do Excel</h3>
                <div class="registration-form" style="margin: 15px 0; border: none; background: #f8f9fa;">
                    <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                        <strong>📋 Instruções:</strong><br>
                        1. O arquivo Excel deve ter as colunas na ordem correta<br>
                        2. A primeira linha deve conter os cabeçalhos<br>
                        3. Formato esperado: .xlsx ou .xls
                    </div>

                    <label>Selecione o arquivo Excel:</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" 
                           style="width: 100%; padding: 10px; border: 2px dashed #3498db; border-radius: 8px; background: white;">
                    
                    <div id="filePreview" style="display: none; margin-top: 15px;">
                        <h4>📊 Pré-visualização dos Dados</h4>
                        <div id="previewTable" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="processExcelFile()" 
                                style="background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold;">
                            <i class="fas fa-upload"></i> Importar para o Supabase
                        </button>
                        <button onclick="closeDataPopup()" 
                                style="background: #95a5a6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>

                <div class="sheet-info" style="background: #fff3cd; margin-top: 15px;">
                    <strong>📝 Estrutura Esperada das Colunas:</strong><br>
                    <div style="columns: 2; margin-top: 10px;">
                        <div>1. Nome</div>
                        <div>2. Data de Entrada</div>
                        <div>3. Serviço Demandante</div>
                        <div>4. Telefone</div>
                        <div>5. Pai</div>
                        <div>6. Mãe</div>
                        <div>7. Sexo</div>
                        <div>8. Gênero</div>
                        <div>9. Data de Nascimento</div>
                        <div>10. Idade</div>
                        <div>11. Naturalidade</div>
                        <div>12. Escolaridade</div>
                        <div>13. Raça</div>
                        <div>14. Descrição de Itens</div>
                        <div>15. RG</div>
                        <div>16. CPF</div>
                        <div>17. SUS</div>
                        <div>18. Título de Eleitor</div>
                        <div>19. CTPS</div>
                        <div>20. NIS</div>
                        <div>21. Observações</div>
                        <div>22. Restrição</div>
                        <div>23. CAPS</div>
                        <div>24. Exames</div>
                        <div>25. Técnico</div>
                        <div>26. Porteiro</div>
                    </div>
                </div>
            `;
            
            popupContent.innerHTML = html;
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';

            // Configurar evento para pré-visualização
            document.getElementById('excelFile').addEventListener('change', handleFileSelect);
        }

        // FUNÇÃO: Manipular seleção de arquivo
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const previewDiv = document.getElementById('filePreview');
            const previewTable = document.getElementById('previewTable');

            try {
                previewTable.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Carregando pré-visualização...</p>';
                previewDiv.style.display = 'block';

                const data = await readExcelFile(file);
                displayPreview(data);
                
            } catch (error) {
                previewTable.innerHTML = `<p style="color: #e74c3c; text-align: center;">Erro ao ler arquivo: ${error.message}</p>`;
            }
        }

        // FUNÇÃO: Ler arquivo Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Pegar a primeira planilha
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Converter para JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Erro ao ler o arquivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // FUNÇÃO: Exibir pré-visualização
        function displayPreview(data) {
            const previewTable = document.getElementById('previewTable');
            
            if (!data || data.length === 0) {
                previewTable.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nenhum dado encontrado no arquivo.</p>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.8em;">';
            
            // Cabeçalho
            html += '<tr style="background: #005952; color: white;">';
            if (data[0]) {
                data[0].forEach((header, index) => {
                    html += `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${header || `Coluna ${index + 1}`}</th>`;
                });
            }
            html += '</tr>';
            
            // Dados (máximo 10 linhas para preview)
            const maxRows = Math.min(data.length, 11); // 1 cabeçalho + 10 dados
            for (let i = 1; i < maxRows; i++) {
                html += '<tr style="background: ' + (i % 2 === 0 ? '#f9f9f9' : 'white') + ';">';
                if (data[i]) {
                    data[i].forEach(cell => {
                        html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: left;">${cell || ''}</td>`;
                    });
                }
                html += '</tr>';
            }
            
            html += '</table>';
            
            if (data.length > 11) {
                html += `<p style="text-align: center; color: #7f8c8d; margin-top: 10px;">
                    ... e mais ${data.length - 11} linhas
                </p>`;
            }
            
            previewTable.innerHTML = html;
        }

        // FUNÇÃO: Processar arquivo Excel e enviar para Supabase
        async function processExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessageBox('Por favor, selecione um arquivo Excel.');
                return;
            }

            try {
                showMessageBox('Processando arquivo Excel...\n\nAguarde, isso pode levar alguns segundos.');
                
                const data = await readExcelFile(file);
                
                if (!data || data.length < 2) {
                    showMessageBox('O arquivo está vazio ou não contém dados.');
                    return;
                }

                // Processar dados
                const acolhidosData = processExcelData(data);
                
                if (acolhidosData.length === 0) {
                    showMessageBox('Nenhum dado válido encontrado para importar.');
                    return;
                }

                // Confirmar importação
                const confirmar = await showMessageBox(
                    `Deseja importar ${acolhidosData.length} registros para o Supabase?\n\nEsta ação não pode ser desfeita.`,
                    'confirm'
                );

                if (!confirmar) return;

                // Enviar para Supabase
                await importToSupabase(acolhidosData);
                
            } catch (error) {
                console.error('Erro no processamento:', error);
                showMessageBox('Erro ao processar arquivo: ' + error.message);
            }
        }

        // FUNÇÃO: Processar dados do Excel
        function processExcelData(data) {
            const acolhidos = [];
            const headers = data[0]; // Primeira linha são os cabeçalhos
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                // Mapear colunas conforme a estrutura esperada
                const acolhido = {
                    nome: row[0] || null,                    // Nome
                    data_de_entrada: formatExcelDate(row[1]), // Data de Entrada
                    servico_demandante: row[2] || null,      // Serviço Demandante
                    telefone: row[3] || null,                // Telefone
                    pai: row[4] || null,                     // Pai
                    mae: row[5] || null,                     // Mãe
                    sexo: row[6] || null,                    // Sexo
                    genero: row[7] || null,                  // Gênero
                    data_nascimento: formatExcelDate(row[8]), // Data de Nascimento
                    idade: row[9] || null,                   // Idade
                    naturalidade: row[10] || null,           // Naturalidade
                    escolaridade: row[11] || null,           // Escolaridade
                    raca: row[12] || null,                   // Raça
                    descricao_itens: row[13] || null,        // Descrição de Itens
                    rg: row[14] || null,                     // RG
                    cpf: row[15] || null,                    // CPF
                    sus: row[16] || null,                    // SUS
                    titulo_eleitor: row[17] || null,         // Título de Eleitor
                    ctps: row[18] || null,                   // CTPS
                    nis: row[19] || null,                    // NIS
                    obs: row[20] || null,                    // Observações
                    restricao: row[21] || null,              // Restrição
                    caps: row[22] || null,                   // CAPS
                    exames: row[23] || null,                 // Exames
                    tecnico: row[24] || null,                // Técnico
                    porteiro: row[25] || null                // Porteiro
                };
                
                // Só adicionar se tiver pelo menos o nome
                if (acolhido.nome && acolhido.nome.trim() !== '') {
                    acolhidos.push(acolhido);
                }
            }
            
            return acolhidos;
        }

        // FUNÇÃO: Formatar data do Excel
        function formatExcelDate(excelDate) {
            if (!excelDate) return null;
            
            // Se já for uma string de data
            if (typeof excelDate === 'string') {
                // Tentar converter de DD/MM/AAAA
                const parts = excelDate.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return excelDate;
            }
            
            // Se for número do Excel (dias desde 1900)
            if (typeof excelDate === 'number') {
                try {
                    const date = new Date((excelDate - 25569) * 86400 * 1000);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return null;
                }
            }
            
            return null;
        }

        // FUNÇÃO: Importar para Supabase
        async function importToSupabase(acolhidosData) {
            try {
                showMessageBox(`Enviando ${acolhidosData.length} registros para o Supabase...\n\nNão feche esta janela.`);
                
                const { data, error } = await supabase
                    .from('acolhidos')
                    .insert(acolhidosData)
                    .select();

                if (error) throw error;

                closeDataPopup();
                showMessageBox(`✅ Importação concluída com sucesso!\n\n${acolhidosData.length} registros foram adicionados ao sistema.`);
                
                // Atualizar dados
                loadAcolhidos();
                
            } catch (error) {
                console.error('Erro na importação:', error);
                
                if (error.code === '23505') {
                    showMessageBox('Erro: Alguns registros já existen no sistema (violação de chave única).');
                } else {
                    showMessageBox('Erro ao importar para o Supabase: ' + error.message);
                }
            }
        }

        // =============================================
        // FUNÇÕES DE SINCRONIZAÇÃO COM GOOGLE SHEETS
        // =============================================

        async function syncWithGoogleSheet() {
            const sheetUrl = prompt('Cole a URL da planilha do Google Sheets:\n\nA planilha deve estar configurada como "Qualquer pessoa com o link pode visualizar"');
            if (!sheetUrl) return;

            try {
                showMessageBox('Carregando informações da planilha...\n\nAguarde alguns segundos.');
                
                const sheetId = extractSheetId(sheetUrl);
                if (!sheetId) {
                    throw new Error('URL da planilha inválida. Certifique-se de que é uma URL do Google Sheets.');
                }
                
                currentSheetId = sheetId;
                showSheetSelectionInterface(sheetId);
                
            } catch (error) {
                console.error('Erro ao carregar planilha:', error);
                showMessageBox('Erro ao carregar planilha: ' + error.message);
            }
        }

        // FUNÇÃO: Mostra interface para selecionar a aba
        function showSheetSelectionInterface(sheetId) {
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            let html = `
                <div class="sheet-selection">
                    <h4>📋 Selecione a Aba da Planilha</h4>
                    <div class="sheet-info">
                        <strong>Planilha carregada com sucesso!</strong><br>
                        Selecione uma das abas abaixo ou digite o nome manualmente
                    </div>
                    
                    <h5 style="color: #005952; margin: 15px 0 8px 0;">Abas Sugeridas:</h5>
                    <div class="sheets-container" id="sheetsContainer">
            `;
            
            COMMON_SHEETS.forEach((sheet, index) => {
                html += `
                    <div class="sheet-option ${index === 0 ? 'selected' : ''}" 
                         onclick="selectSheet('${sheet}', '${sheetId}')">
                        <i class="fas fa-table"></i><br>
                        ${sheet}
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="custom-sheet-input">
                    <input type="text" id="customSheetName" placeholder="Ou digite o nome exato da aba..." 
                           onkeypress="if(event.key=='Enter') addCustomSheet()">
                    <button onclick="addCustomSheet()">
                        <i class="fas fa-plus"></i> Usar
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="close-popup" onclick="loadSheetData('${sheetId}')" 
                            style="background: #27ae60; margin-right: 10px;">
                        <i class="fas fa-check"></i> Carregar Dados da Aba Selecionada
                    </button>
                    <button class="close-popup" onclick="closeDataPopup()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
            <div id="sheetDataPreview" style="margin-top: 15px;"></div>
            `;
            
            popupContent.innerHTML = html;
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            selectedSheet = COMMON_SHEETS[0];
            closeMessageBox();
            
            loadSheetPreview(sheetId, selectedSheet);
        }

        // FUNÇÃO: Adiciona aba personalizada
        function addCustomSheet() {
            const customSheetName = document.getElementById('customSheetName').value.trim();
            if (!customSheetName) {
                showMessageBox('Por favor, digite o nome da aba.');
                return;
            }
            
            selectedSheet = customSheetName.toUpperCase();
            
            document.querySelectorAll('.sheet-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const previewElement = document.getElementById('sheetDataPreview');
            previewElement.innerHTML = `
                <div class="sheet-info" style="background: #d1ecf1; border-left-color: #3498db;">
                    <strong>Aba personalizada selecionada:</strong> ${selectedSheet}<br>
                    Clique em "Carregar Dados" para visualizar
                </div>
            `;
        }

        // FUNÇÃO: Seleciona uma aba
        function selectSheet(sheetName, sheetId) {
            selectedSheet = sheetName;
            
            document.querySelectorAll('.sheet-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.target.closest('.sheet-option').classList.add('selected');
            
            document.getElementById('customSheetName').value = '';
            
            loadSheetPreview(sheetId, sheetName);
        }

        // FUNÇÃO: Carrega preview dos dados da aba selecionada
        async function loadSheetPreview(sheetId, sheetName) {
            try {
                const previewElement = document.getElementById('sheetDataPreview');
                previewElement.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Carregando preview da aba "' + sheetName + '"...</p>';
                
                const sheetData = await fetchGoogleSheetData(sheetId, sheetName);
                const headers = [];
                
                if (sheetData.table?.rows?.[0]?.c) {
                    sheetData.table.rows[0].c.forEach((cell, index) => {
                        headers.push(getCellDisplayValue(cell) || `Coluna ${String.fromCharCode(65 + index)}`);
                    });
                }
                
                let previewHtml = `
                    <div class="sheet-info">
                        <strong>Aba selecionada:</strong> ${sheetName}<br>
                        <strong>Colunas detectadas:</strong> ${headers.length}<br>
                        <strong>Estrutura:</strong>
                `;
                
                if (headers.length > 0) {
                    headers.forEach((header, index) => {
                        previewHtml += `<br>• ${header}`;
                    });
                } else {
                    previewHtml += `<br>• Nenhuma coluna detectada (aba pode estar vazia)`;
                }
                
                const dataRows = sheetData.table?.rows ? sheetData.table.rows.length - 1 : 0;
                previewHtml += `<br><strong>Linhas de dados:</strong> ${dataRows}`;
                
                previewHtml += `</div>`;
                previewElement.innerHTML = previewHtml;
                
            } catch (error) {
                document.getElementById('sheetDataPreview').innerHTML = `
                    <div class="sheet-info" style="background: #f8d7da; border-left-color: #e74c3c;">
                        <strong>Erro ao carregar aba "${sheetName}":</strong><br>
                        ${error.message}<br><br>
                        <em>Tente selecionar outra aba ou verifique o nome.</em>
                    </div>
                `;
            }
        }

        // FUNÇÃO: Carrega dados da aba selecionada
        async function loadSheetData(sheetId) {
            if (!selectedSheet) {
                showMessageBox('Por favor, selecione uma aba primeiro.');
                return;
            }

            try {
                showMessageBox(`Carregando dados da aba "${selectedSheet}"...\n\nAguarde alguns segundos.`);
                
                const sheetData = await fetchGoogleSheetData(sheetId, selectedSheet);
                await showSheetDataInPopup(sheetData, selectedSheet);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showMessageBox('Erro ao carregar dados da aba "' + selectedSheet + '": ' + error.message);
            }
        }

        // FUNÇÃO: Busca dados do Google Sheets
        async function fetchGoogleSheetData(sheetId, sheetName = 'Página1') {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Não foi possível acessar a aba "${sheetName}". Verifique se o nome está correto.`);
            }
            
            const text = await response.text();
            
            if (text.includes('error') || text.length < 50) {
                throw new Error(`A aba "${sheetName}" não foi encontrada ou está vazia.`);
            }
            
            try {
                const json = JSON.parse(text.substring(47).slice(0, -2));
                return json;
            } catch (parseError) {
                throw new Error(`Erro ao processar dados da aba "${sheetName}".`);
            }
        }

        // FUNÇÃO: Obtém valor de exibição da célula
        function getCellDisplayValue(cell) {
            if (!cell) return '';
            
            if (cell.f) {
                return cell.f;
            }
            
            if (cell.v !== null && cell.v !== undefined) {
                if (typeof cell.v === 'number') {
                    if (cell.v > 25568) {
                        try {
                            const date = new Date((cell.v - 25569) * 86400 * 1000);
                            if (!isNaN(date.getTime())) {
                                return date.toLocaleDateString('pt-BR');
                            }
                        } catch (e) {
                            console.log('Erro ao converter data:', e);
                        }
                    }
                    
                    if (cell.v >= 0 && cell.v < 1) {
                        try {
                            const totalSeconds = cell.v * 24 * 60 * 60;
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        } catch (e) {
                            console.log('Erro ao converter hora:', e);
                        }
                    }
                    
                    return String(cell.v);
                }
                
                return String(cell.v);
            }
            
            return '';
        }

        // FUNÇÃO: Detecta e formata dados baseado na estrutura da planilha
        function formatCellByStructure(value, cell, columnIndex, rowIndex, headers) {
            if (!value) return value;
            
            if (columnIndex === 0) {
                return formatAsDate(value, cell);
            }
            
            if (columnIndex === 2) {
                return formatAsTime(value, cell);
            }
            
            return value;
        }

        // FUNÇÃO: Formata como data
        function formatAsDate(value, cell) {
            if (!value) return '';
            
            if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                return value;
            }
            
            if (value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = value.split('-');
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            
            if (cell && typeof cell.v === 'number' && cell.v > 25568) {
                try {
                    const date = new Date((cell.v - 25569) * 86400 * 1000);
                    return date.toLocaleDateString('pt-BR');
                } catch (e) {
                }
            }
            
            return value;
        }

        // FUNÇÃO: Formata como hora
        function formatAsTime(value, cell) {
            if (!value) return '';
            
            if (value.match(/^\d{1,2}:\d{2}$/)) {
                const [hours, minutes] = value.split(':');
                return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
            }
            
            if (cell && typeof cell.v === 'number' && cell.v < 1 && cell.v >= 0) {
                try {
                    const totalSeconds = cell.v * 24 * 60 * 60;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                } catch (e) {
                }
            }
            
            return value;
        }

        // FUNÇÃO: Mostra dados em popup
        async function showSheetDataInPopup(sheetData, sheetName) {
            if (!sheetData?.table?.rows) {
                throw new Error('Estrutura de dados da planilha inválida.');
            }
            
            const rows = sheetData.table.rows;
            const headers = [];
            
            if (rows.length > 0 && rows[0].c) {
                rows[0].c.forEach((cell, index) => {
                    headers.push(getCellDisplayValue(cell) || `Coluna ${String.fromCharCode(65 + index)}`);
                });
            }
            
            const tableData = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row?.c) continue;
                
                const rowData = {};
                let hasData = false;
                
                row.c.forEach((cell, index) => {
                    let value = getCellDisplayValue(cell);
                    value = formatCellByStructure(value, cell, index, i, headers);
                    rowData[headers[index]] = value;
                    if (value?.trim()) hasData = true;
                });
                
                if (hasData) tableData.push(rowData);
            }
            
            displayDataInPopup(headers, tableData, sheetName);
        }

        // FUNÇÃO: Mostra dados com informação da aba
        function displayDataInPopup(headers, data, sheetName) {
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            if (!data.length) {
                popupContent.innerHTML = `
                    <div class="sheet-info">
                        <strong>Aba:</strong> ${sheetName}<br>
                        <strong>Status:</strong> Carregada com sucesso, mas sem dados<br>
                        <p style="text-align: center; color: #7f8c8d; margin-top: 10px;">
                            A aba "${sheetName}" foi carregada, mas não contém dados ou contém apenas cabeçalhos.
                        </p>
                    </div>
                `;
            } else {
                let html = `
                    <div class="sheet-info">
                        <strong>Aba carregada:</strong> ${sheetName}<br>
                        <strong>Total de registros:</strong> ${data.length}<br>
                        <strong>Colunas:</strong> ${headers.length}
                    </div>
                    
                    <div class="sheet-info" style="background: #d1ecf1; border-left-color: #3498db;">
                        <strong>📅 Estrutura Detectada:</strong><br>
                        • <strong>Coluna A:</strong> Data (DD/MM/AAAA)<br>
                        • <strong>Coluna B:</strong> Dia da semana<br>
                        • <strong>Coluna C:</strong> Horário (HH:MM)<br>
                        • <strong>Coluna D:</strong> Carro<br>
                        • <strong>Coluna E:</strong> Nome
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 60vh;">
                    <table class="data-table">
                `;
                
                html += '<tr>';
                headers.forEach((header, index) => {
                    let classAttr = '';
                    let colName = `Coluna ${String.fromCharCode(65 + index)}`;
                    
                    if (index === 0) {
                        classAttr = 'class="date-column"';
                        colName = '📅 Data';
                    } else if (index === 1) {
                        classAttr = 'class="day-column"';
                        colName = '📆 Dia';
                    } else if (index === 2) {
                        classAttr = 'class="time-column"';
                        colName = '⏰ Horário';
                    } else if (index === 3) {
                        colName = '🚗 Carro';
                    } else if (index === 4) {
                        colName = '👤 Nome';
                    }
                    
                    html += `<th ${classAttr}>${colName}</th>`;
                });
                html += '</tr>';
                
                data.forEach((row, rowIndex) => {
                    const rowValues = Object.values(row).filter(val => val && val.trim());
                    if (rowValues.length < 2) return;
                    
                    html += '<tr>';
                    headers.forEach((header, index) => {
                        const value = row[header] || '';
                        const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                        
                        let classAttr = '';
                        if (index === 0) {
                            classAttr = 'class="date-column"';
                        } else if (index === 1) {
                            classAttr = 'class="day-column"';
                        } else if (index === 2) {
                            classAttr = 'class="time-column"';
                        }
                        
                        html += `<td ${classAttr} title="${value}">${displayValue}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table></div>';
                
                html += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="close-popup" onclick="closeDataPopup()">
                            <i class="fas fa-times"></i> Fechar
                        </button>
                    </div>
                    
                    <div class="sheet-info" style="background: #e8f5e9; margin-top: 10px;">
                        <strong>💡 Dica:</strong> Abra o Console (F12) para ver informações detalhadas dos dados
                    </div>
                `;
                
                popupContent.innerHTML = html;
            }
            
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            closeMessageBox();
        }

        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        // =============================================
        // SISTEMA DE GERENCIAMENTO DE USUÁRIOS
        // =============================================

        // FUNÇÃO ATUALIZADA: Gerenciar múltiplos usuários
        async function gerenciarSenhas() {
            if (!checkAccess('admin')) return;
            
            try {
                // Carregar todos os usuários
                const { data: usuarios, error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .select('*')
                    .order('nivel_acesso', { ascending: true })
                    .order('usuario_nome', { ascending: true });
                    
                if (error) throw error;
                
                // Criar pop-up de gerenciamento
                const popupContent = document.getElementById('popupContent');
                const dataPopup = document.getElementById('dataPopup');
                
                let html = `
                    <h3>🔑 Gerenciamento de Usuários</h3>
                    <div style="margin: 15px 0;">
                        <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                            <strong>📋 Gerenciar Usuários e Senhas:</strong><br>
                            Aqui você pode adicionar, editar e remover usuários do sistema
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button onclick="showNovoUsuarioForm()" 
                                    style="background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-user-plus"></i> Adicionar Novo Usuário
                            </button>
                        </div>
                        
                        <div id="usuarios-list">
                            <h4 style="color: #005952; margin-bottom: 15px;">Usuários Cadastrados</h4>
                `;
                
                if (!usuarios || usuarios.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                            <i class="fas fa-users" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                            Nenhum usuário cadastrado
                        </div>
                    `;
                } else {
                    // Agrupar por nível de acesso
                    const usuariosPorNivel = {
                        'admin': usuarios.filter(u => u.nivel_acesso === 'admin'),
                        'tecnico': usuarios.filter(u => u.nivel_acesso === 'tecnico'),
                        'portaria': usuarios.filter(u => u.nivel_acesso === 'portaria')
                    };
                    
                    const niveis = [
                        { id: 'admin', nome: 'Administradores', icon: 'fa-user-shield', color: '#e74c3c' },
                        { id: 'tecnico', nome: 'Técnicos', icon: 'fa-user-friends', color: '#3498db' },
                        { id: 'portaria', nome: 'Portaria', icon: 'fa-door-closed', color: '#95a5a6' }
                    ];
                    
                    niveis.forEach(nivel => {
                        const usuariosNivel = usuariosPorNivel[nivel.id];
                        if (usuariosNivel && usuariosNivel.length > 0) {
                            html += `
                                <div style="margin-bottom: 25px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: ${nivel.color}15; border-radius: 8px;">
                                        <i class="fas ${nivel.icon}" style="color: ${nivel.color}; font-size: 1.2em; margin-right: 10px;"></i>
                                        <h5 style="color: ${nivel.color}; margin: 0;">${nivel.nome}</h5>
                                    </div>
                            `;
                            
                            usuariosNivel.forEach(usuario => {
                                const statusBadge = usuario.ativo ? 
                                    '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em;">ATIVO</span>' :
                                    '<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em;">INATIVO</span>';
                                
                                html += `
                                    <div class="usuario-item" style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${nivel.color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: bold; font-size: 1.1em;">${usuario.usuario_nome}</div>
                                                <div style="font-size: 0.85em; color: #7f8c8d;">
                                                    Login: ${usuario.login} | ${statusBadge}
                                                </div>
                                                ${usuario.email ? `<div style="font-size: 0.8em; color: #7f8c8d;">Email: ${usuario.email}</div>` : ''}
                                                ${usuario.observacoes ? `<div style="font-size: 0.8em; color: #7f8c8d;">Obs: ${usuario.observacoes}</div>` : ''}
                                            </div>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick="editarUsuario('${usuario.id}')" 
                                                        style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="alternarStatusUsuario('${usuario.id}', ${!usuario.ativo})" 
                                                        style="background: ${usuario.ativo ? '#e67e22' : '#27ae60'}; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                                                    <i class="fas ${usuario.ativo ? 'fa-pause' : 'fa-play'}"></i>
                                                </button>
                                                ${usuariosNivel.length > 1 ? `
                                                <button onclick="excluirUsuario('${usuario.id}')" 
                                                        style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div style="font-size: 0.75em; color: #7f8c8d;">
                                            Criado: ${new Date(usuario.created_at).toLocaleString('pt-BR')}
                                            ${usuario.updated_at !== usuario.created_at ? ` | Atualizado: ${new Date(usuario.updated_at).toLocaleString('pt-BR')}` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `</div>`;
                        }
                    });
                }
                
                html += `
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="close-popup" onclick="closeDataPopup()">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    </div>
                    
                    <div id="novo-usuario-form" style="display: none;"></div>
                `;
                
                popupContent.innerHTML = html;
                dataPopup.style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showMessageBox('Erro ao carregar usuários: ' + error.message);
            }
        }

        // FUNÇÃO: Mostrar formulário para novo usuário
        function showNovoUsuarioForm() {
            const formContainer = document.getElementById('novo-usuario-form');
            
            formContainer.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid #005952;">
                    <h4 style="color: #005952; margin-bottom: 15px;">➕ Adicionar Novo Usuário</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="novo-usuario-nome">Nome Completo:</label>
                            <input type="text" id="novo-usuario-nome" placeholder="Digite o nome completo" 
                                   style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="novo-usuario-login">Login:</label>
                            <input type="text" id="novo-usuario-login" placeholder="Digite o login" 
                                   style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="novo-usuario-senha">Senha:</label>
                            <input type="password" id="novo-usuario-senha" placeholder="Digite a senha" 
                                   style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="novo-usuario-confirmar">Confirmar Senha:</label>
                            <input type="password" id="novo-usuario-confirmar" placeholder="Confirme a senha" 
                                   style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="novo-usuario-nivel">Nível de Acesso:</label>
                            <select id="novo-usuario-nivel" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                                <option value="portaria">Portaria</option>
                                <option value="tecnico">Técnico</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="novo-usuario-email">Email (opcional):</label>
                            <input type="email" id="novo-usuario-email" placeholder="Digite o email" 
                                   style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="novo-usuario-observacoes">Observações (opcional):</label>
                        <textarea id="novo-usuario-observacoes" rows="2" placeholder="Observações sobre o usuário"
                                  style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="salvarNovoUsuario()" 
                                style="background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; flex: 1;">
                            <i class="fas fa-save"></i> Salvar Usuário
                        </button>
                        <button onclick="cancelarNovoUsuario()" 
                                style="background: #95a5a6; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; flex: 1;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            formContainer.style.display = 'block';
        }

        // FUNÇÃO: Salvar novo usuário
        async function salvarNovoUsuario() {
            const nome = document.getElementById('novo-usuario-nome').value.trim();
            const login = document.getElementById('novo-usuario-login').value.trim();
            const senha = document.getElementById('novo-usuario-senha').value;
            const confirmar = document.getElementById('novo-usuario-confirmar').value;
            const nivel = document.getElementById('novo-usuario-nivel').value;
            const email = document.getElementById('novo-usuario-email').value.trim();
            const observacoes = document.getElementById('novo-usuario-observacoes').value.trim();
            
            // Validações
            if (!nome || !login || !senha || !confirmar) {
                showMessageBox('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (senha !== confirmar) {
                showMessageBox('As senhas não coincidem. Por favor, digite novamente.');
                return;
            }
            
            if (senha.length < 4) {
                showMessageBox('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            if (login.length < 3) {
                showMessageBox('O login deve ter pelo menos 3 caracteres.');
                return;
            }
            
            try {
                // Verificar se o login já existe
                const { data: usuarioExistente, error: checkError } = await supabase
                    .from('gerenciamento_de_senhas')
                    .select('id')
                    .eq('login', login);
                    
                if (checkError) throw checkError;
                
                if (usuarioExistente && usuarioExistente.length > 0) {
                    showMessageBox('Este login já está em uso. Por favor, escolha outro login.');
                    return;
                }
                
                // Inserir novo usuário
                const novoUsuario = {
                    usuario_nome: nome,
                    login: login,
                    senha: senha,
                    nivel_acesso: nivel,
                    email: email || null,
                    observacoes: observacoes || null,
                    ativo: true
                };
                
                const { data, error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .insert([novoUsuario])
                    .select();
                    
                if (error) throw error;
                
                showMessageBox('✅ Usuário criado com sucesso!');
                
                // Recarregar a lista de usuários
                gerenciarSenhas();
                
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
                showMessageBox('Erro ao criar usuário: ' + error.message);
            }
        }

        // FUNÇÃO: Cancelar novo usuário
        function cancelarNovoUsuario() {
            document.getElementById('novo-usuario-form').style.display = 'none';
        }

        // FUNÇÃO: Editar usuário
        async function editarUsuario(usuarioId) {
            try {
                // Carregar dados do usuário
                const { data: usuario, error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .select('*')
                    .eq('id', usuarioId)
                    .single();
                    
                if (error) throw error;
                
                const formContainer = document.getElementById('novo-usuario-form');
                
                formContainer.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid #3498db;">
                        <h4 style="color: #3498db; margin-bottom: 15px;">✏️ Editar Usuário</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="edit-usuario-nome">Nome Completo:</label>
                                <input type="text" id="edit-usuario-nome" value="${usuario.usuario_nome}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-usuario-login">Login:</label>
                                <input type="text" id="edit-usuario-login" value="${usuario.login}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="edit-usuario-senha">Nova Senha (deixe em branco para manter atual):</label>
                                <input type="password" id="edit-usuario-senha" placeholder="Nova senha" 
                                       style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-usuario-confirmar">Confirmar Nova Senha:</label>
                                <input type="password" id="edit-usuario-confirmar" placeholder="Confirmar nova senha" 
                                       style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="edit-usuario-nivel">Nível de Acesso:</label>
                                <select id="edit-usuario-nivel" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                                    <option value="portaria" ${usuario.nivel_acesso === 'portaria' ? 'selected' : ''}>Portaria</option>
                                    <option value="tecnico" ${usuario.nivel_acesso === 'tecnico' ? 'selected' : ''}>Técnico</option>
                                    <option value="admin" ${usuario.nivel_acesso === 'admin' ? 'selected' : ''}>Administrador</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-usuario-email">Email:</label>
                                <input type="email" id="edit-usuario-email" value="${usuario.email || ''}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-usuario-observacoes">Observações:</label>
                            <textarea id="edit-usuario-observacoes" rows="2"
                                      style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">${usuario.observacoes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="atualizarUsuario('${usuario.id}')" 
                                    style="background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; flex: 1;">
                                <i class="fas fa-save"></i> Atualizar Usuário
                            </button>
                            <button onclick="cancelarNovoUsuario()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; flex: 1;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                formContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
                showMessageBox('Erro ao carregar dados do usuário: ' + error.message);
            }
        }

        // FUNÇÃO: Atualizar usuário
        async function atualizarUsuario(usuarioId) {
            const nome = document.getElementById('edit-usuario-nome').value.trim();
            const login = document.getElementById('edit-usuario-login').value.trim();
            const senha = document.getElementById('edit-usuario-senha').value;
            const confirmar = document.getElementById('edit-usuario-confirmar').value;
            const nivel = document.getElementById('edit-usuario-nivel').value;
            const email = document.getElementById('edit-usuario-email').value.trim();
            const observacoes = document.getElementById('edit-usuario-observacoes').value.trim();
            
            // Validações
            if (!nome || !login) {
                showMessageBox('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (senha && senha !== confirmar) {
                showMessageBox('As senhas não coincidem. Por favor, digite novamente.');
                return;
            }
            
            if (senha && senha.length < 4) {
                showMessageBox('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            if (login.length < 3) {
                showMessageBox('O login deve ter pelo menos 3 caracteres.');
                return;
            }
            
            try {
                // Verificar se o login já existe (excluindo o usuário atual)
                const { data: usuarioExistente, error: checkError } = await supabase
                    .from('gerenciamento_de_senhas')
                    .select('id')
                    .eq('login', login)
                    .neq('id', usuarioId);
                    
                if (checkError) throw checkError;
                
                if (usuarioExistente && usuarioExistente.length > 0) {
                    showMessageBox('Este login já está em uso por outro usuário. Por favor, escolha outro login.');
                    return;
                }
                
                // Preparar dados para atualização
                const dadosAtualizacao = {
                    usuario_nome: nome,
                    login: login,
                    nivel_acesso: nivel,
                    email: email || null,
                    observacoes: observacoes || null,
                    updated_at: new Date().toISOString()
                };
                
                // Incluir senha apenas se foi alterada
                if (senha) {
                    dadosAtualizacao.senha = senha;
                }
                
                const { data, error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .update(dadosAtualizacao)
                    .eq('id', usuarioId)
                    .select();
                    
                if (error) throw error;
                
                showMessageBox('✅ Usuário atualizado com sucesso!');
                
                // Recarregar a lista de usuários
                gerenciarSenhas();
                
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error);
                showMessageBox('Erro ao atualizar usuário: ' + error.message);
            }
        }

        // FUNÇÃO: Alternar status do usuário (ativo/inativo)
        async function alternarStatusUsuario(usuarioId, novoStatus) {
            try {
                const { error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .update({ 
                        ativo: novoStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', usuarioId);
                    
                if (error) throw error;
                
                showMessageBox(`✅ Usuário ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`);
                
                // Recarregar a lista de usuários
                gerenciarSenhas();
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showMessageBox('Erro ao alterar status do usuário: ' + error.message);
            }
        }

        // FUNÇÃO: Excluir usuário
        async function excluirUsuario(usuarioId) {
            const confirmar = await showMessageBox(
                'Tem certeza que deseja excluir este usuário?\n\nEsta ação não pode ser desfeita.',
                'confirm'
            );
            
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('gerenciamento_de_senhas')
                    .delete()
                    .eq('id', usuarioId);
                    
                if (error) throw error;
                
                showMessageBox('✅ Usuário excluído com sucesso!');
                
                // Recarregar a lista de usuários
                gerenciarSenhas();
                
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showMessageBox('Erro ao excluir usuário: ' + error.message);
            }
        }

        // =============================================
        // FUNÇÕES EXPORTAR PDF E EXCEL - ATUALIZADAS
        // =============================================

        // FUNÇÃO EXPORTAR PDF - ATUALIZADA
        async function exportToPdf() {
            try {
                const popupContent = document.getElementById('popupContent');
                const dataPopup = document.getElementById('dataPopup');
                
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const html = `
                    <h3>📊 Exportar Relatório em PDF</h3>
                    <div class="registration-form" style="margin: 15px 0; border: none; background: #f8f9fa;">
                        <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                            <strong>📋 Filtro por Data:</strong><br>
                            Selecione o período desejado para gerar o relatório
                        </div>

                        <label>Data Inicial:</label>
                        <input type="date" id="data-inicio" value="${firstDay.toISOString().split('T')[0]}" 
                               style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">

                        <label>Data Final:</label>
                        <input type="date" id="data-fim" value="${today.toISOString().split('T')[0]}" 
                               style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">

                        <label>Tipo de Movimentação:</label>
                        <select id="tipo-movimentacao" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <option value="todos">Todos os Tipos</option>
                            <option value="entrada">Apenas Entradas</option>
                            <option value="saida">Apenas Saídas</option>
                        </select>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="gerarPreviewPdf()" 
                                    style="background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold;">
                                <i class="fas fa-eye"></i> Visualizar Prévia
                            </button>
                            <button onclick="gerarRelatorioPdf()" 
                                    style="background: #e74c3c; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; flex: 1; font-weight: bold;">
                                <i class="fas fa-file-pdf"></i> Baixar PDF
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button onclick="closeDataPopup()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; width: 100%;">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    </div>
                    
                    <div id="pdf-preview-container" style="display: none; margin-top: 20px;">
                        <h4 style="color: #005952; margin-bottom: 10px;">📋 Prévia do Relatório</h4>
                        <div id="pdf-preview-content" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                `;
                
                popupContent.innerHTML = html;
                dataPopup.style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao abrir popup de PDF:', error);
                showMessageBox('Erro ao abrir interface de exportação: ' + error.message);
            }
        }

        // FUNÇÃO: Gerar prévia do PDF
        async function gerarPreviewPdf() {
            try {
                const dataInicio = document.getElementById('data-inicio').value;
                const dataFim = document.getElementById('data-fim').value;
                const tipoMovimentacao = document.getElementById('tipo-movimentacao').value;
                
                if (!dataInicio || !dataFim) {
                    showMessageBox('Por favor, selecione ambas as datas.');
                    return;
                }
                
                if (new Date(dataInicio) > new Date(dataFim)) {
                    showMessageBox('A data inicial não pode ser maior que a data final.');
                    return;
                }
                
                // Mostrar loading
                const previewContainer = document.getElementById('pdf-preview-container');
                const previewContent = document.getElementById('pdf-preview-content');
                previewContent.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Gerando prévia do relatório...</p>';
                previewContainer.style.display = 'block';
                
                // Buscar dados para a prévia
                const previewData = await getDadosRelatorio(dataInicio, dataFim, tipoMovimentacao);
                
                if (!previewData.movements || previewData.movements.length === 0) {
                    previewContent.innerHTML = '<p style="text-align: center; color: #e74c3c;">Nenhum dado encontrado para o período selecionado.</p>';
                    return;
                }
                
                // Gerar HTML da prévia
                const previewHtml = gerarHtmlPreview(previewData, dataInicio, dataFim, tipoMovimentacao);
                previewContent.innerHTML = previewHtml;
                
                // Scroll para a prévia
                previewContainer.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Erro ao gerar prévia:', error);
                document.getElementById('pdf-preview-content').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c;">Erro ao gerar prévia: ' + error.message + '</p>';
            }
        }

        // FUNÇÃO: Obter dados para o relatório
        async function getDadosRelatorio(dataInicio, dataFim, tipoMovimentacao) {
            // Buscar movimentações
            let query = supabase
                .from('movimentacoes')
                .select(`*, acolhidos (nome)`)
                .gte('data_hora', dataInicio + 'T00:00:00')
                .lte('data_hora', dataFim + 'T23:59:59')
                .order('data_hora', { ascending: false });
            
            if (tipoMovimentacao !== 'todos') {
                query = query.eq('tipo', tipoMovimentacao);
            }
            
            const { data: movements, error } = await query;
            if (error) throw error;
            
            // Buscar acolhidos fora do abrigo
            const acolhidosFora = [];
            for (const acolhido of allAcolhidos) {
                const status = await getAcolhidoStatus(acolhido.id);
                if (status.status === 'fora') {
                    acolhidosFora.push({
                        nome: acolhido.nome,
                        tecnico: acolhido.tecnico,
                        restricao: acolhido.restricao
                    });
                }
            }
            
            return {
                movements: movements || [],
                acolhidosFora: acolhidosFora
            };
        }

        // FUNÇÃO: Gerar HTML da prévia
        function gerarHtmlPreview(data, dataInicio, dataFim, tipoMovimentacao) {
            let html = `
                <div style="border: 2px solid #005952; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h5 style="color: #005952; margin: 0 0 10px 0; text-align: center;">RELATÓRIO DE MOVIMENTAÇÕES - ADRA</h5>
                    <div style="font-size: 0.9em; color: #666; text-align: center; margin-bottom: 15px;">
                        Período: ${formatDateForDisplay(dataInicio)} à ${formatDateForDisplay(dataFim)}<br>
                        Tipo: ${tipoMovimentacao === 'todos' ? 'Todos' : tipoMovimentacao === 'entrada' ? 'Entradas' : 'Saídas'}<br>
                        Total de movimentações: ${data.movements.length}<br>
                        Acolhidos fora do abrigo: ${data.acolhidosFora.length}
                    </div>
            `;
            
            // Seção de Movimentações
            html += `
                <div style="margin-bottom: 20px;">
                    <h6 style="color: #2c3e50; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        📋 MOVIMENTAÇÕES (${data.movements.length})
                    </h6>
            `;
            
            if (data.movements.length === 0) {
                html += '<p style="color: #7f8c8d; text-align: center; font-style: italic;">Nenhuma movimentação no período</p>';
            } else {
                html += '<div style="max-height: 200px; overflow-y: auto;">';
                data.movements.slice(0, 20).forEach((mov, index) => {
                    const movDate = new Date(mov.data_hora);
                    const dataHora = movDate.toLocaleString('pt-BR');
                    const tipo = mov.tipo === 'entrada' ? '🟢 ENTRADA' : '🔴 SAÍDA';
                    
                    html += `
                        <div style="padding: 8px; margin-bottom: 5px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 4px; border-left: 3px solid ${mov.tipo === 'entrada' ? '#27ae60' : '#e74c3c'};">
                            <div style="font-weight: bold; font-size: 0.9em;">${mov.acolhidos?.nome || 'N/A'}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                ${dataHora} | ${tipo} | ${mov.observacao || 'Sem observação'}
                            </div>
                        </div>
                    `;
                });
                
                if (data.movements.length > 20) {
                    html += `<div style="text-align: center; color: #7f8c8d; font-style: italic; margin-top: 8px;">
                        ... e mais ${data.movements.length - 20} movimentações
                    </div>`;
                }
                html += '</div>';
            }
            html += '</div>';
            
            // Seção de Acolhidos Fora do Abrigo
            html += `
                <div>
                    <h6 style="color: #e74c3c; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        🚪 ACOLHIDOS FORA DO ABRIGO (${data.acolhidosFora.length})
                    </h6>
            `;
            
            if (data.acolhidosFora.length === 0) {
                html += '<p style="color: #7f8c8d; text-align: center; font-style: italic;">Todos os acolhidos estão no abrigo</p>';
            } else {
                html += '<div style="max-height: 150px; overflow-y: auto;">';
                data.acolhidosFora.forEach((acolhido, index) => {
                    const restrictionBadge = acolhido.restricao ? 
                        '<span style="background: #e74c3c; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7em; margin-left: 8px;">RESTRIÇÃO</span>' : '';
                    
                    html += `
                        <div style="padding: 6px; margin-bottom: 4px; background: ${index % 2 === 0 ? '#fff3cd' : '#ffeaa7'}; border-radius: 4px; border: 1px solid #ffd43b;">
                            <div style="font-weight: bold; font-size: 0.9em;">
                                ${acolhido.nome}
                                ${restrictionBadge}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Técnico: ${acolhido.tecnico || 'Não atribuído'}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            html += '</div>';
            
            html += `
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; text-align: center;">
                    <small style="color: #7f8c8d;">
                        Gerado em: ${new Date().toLocaleString('pt-BR')}<br>
                        Sistema de Gerenciamento de Acolhidos - ADRA
                    </small>
                </div>
            </div>
            
            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px;">
                <strong>💡 Dica:</strong> Clique em "Baixar PDF" para gerar o arquivo completo
            </div>
            `;
            
            return html;
        }

        // FUNÇÃO: Gerar relatório PDF com os filtros (ATUALIZADA)
        async function gerarRelatorioPdf() {
            try {
                const dataInicio = document.getElementById('data-inicio').value;
                const dataFim = document.getElementById('data-fim').value;
                const tipoMovimentacao = document.getElementById('tipo-movimentacao').value;
                
                if (!dataInicio || !dataFim) {
                    showMessageBox('Por favor, selecione ambas as datas.');
                    return;
                }
                
                if (new Date(dataInicio) > new Date(dataFim)) {
                    showMessageBox('A data inicial não pode ser maior que a data final.');
                    return;
                }
                
                showMessageBox('Gerando relatório PDF...\n\nAguarde alguns segundos.');
                
                // Buscar dados completos
                const dadosCompletos = await getDadosRelatorio(dataInicio, dataFim, tipoMovimentacao);
                
                if (!dadosCompletos.movements || dadosCompletos.movements.length === 0) {
                    closeDataPopup();
                    showMessageBox('Nenhuma movimentação encontrada para o período selecionado.');
                    return;
                }
                
                // Gerar PDF
                await generatePdfReportCompleto(dadosCompletos, dataInicio, dataFim, tipoMovimentacao);
                
                closeDataPopup();
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showMessageBox('Erro ao gerar relatório PDF: ' + error.message);
            }
        }

        // FUNÇÃO: Gerar o PDF completo com jsPDF (ATUALIZADA)
        async function generatePdfReportCompleto(dados, dataInicio, dataFim, tipoMovimentacao) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurações do documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let yPosition = margin;
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 77, 77);
            doc.text('RELATÓRIO COMPLETO - ADRA', pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 8;
            
            // Informações do relatório
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            const periodo = `Período: ${formatDateForDisplay(dataInicio)} à ${formatDateForDisplay(dataFim)}`;
            const tipo = `Tipo de movimentação: ${tipoMovimentacao === 'todos' ? 'Todos' : tipoMovimentacao === 'entrada' ? 'Entradas' : 'Saídas'}`;
            const totalMov = `Movimentações: ${dados.movements.length}`;
            const totalFora = `Acolhidos fora: ${dados.acolhidosFora.length}`;
            const dataGeracao = `Gerado em: ${new Date().toLocaleString('pt-BR')}`;
            
            doc.text(periodo, margin, yPosition);
            yPosition += 5;
            doc.text(tipo, margin, yPosition);
            yPosition += 5;
            doc.text(totalMov, margin, yPosition);
            yPosition += 5;
            doc.text(totalFora, margin, yPosition);
            yPosition += 5;
            doc.text(dataGeracao, margin, yPosition);
            
            yPosition += 12;
            
            // ========== SEÇÃO: ACOLHIDOS FORA DO ABRIGO ==========
            if (dados.acolhidosFora.length > 0) {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(231, 76, 60); // Vermelho
                doc.text('🚪 ACOLHIDOS FORA DO ABRIGO', margin, yPosition);
                yPosition += 8;
                
                // Linha divisória
                doc.setDrawColor(231, 76, 60);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Cabeçalho da tabela de acolhidos fora
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(231, 76, 60);
                doc.setTextColor(255, 255, 255);
                
                const colWidthsFora = [80, 60, 30];
                const headersFora = ['Nome', 'Técnico', 'Restrição'];
                
                let xPosition = margin;
                headersFora.forEach((header, index) => {
                    doc.rect(xPosition, yPosition, colWidthsFora[index], 8, 'F');
                    doc.text(header, xPosition + 2, yPosition + 5);
                    xPosition += colWidthsFora[index];
                });
                
                yPosition += 8;
                
                // Conteúdo da tabela de acolhidos fora
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                dados.acolhidosFora.forEach((acolhido, index) => {
                    // Verificar se precisa de nova página
                    if (yPosition > doc.internal.pageSize.getHeight() - 20) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    // Alternar cores das linhas
                    if (index % 2 === 0) {
                        doc.setFillColor(255, 243, 205); // Amarelo claro
                        doc.rect(margin, yPosition, pageWidth - (2 * margin), 8, 'F');
                    }
                    
                    const restricao = acolhido.restricao ? 'SIM' : 'NÃO';
                    
                    xPosition = margin;
                    const rowData = [
                        acolhido.nome.length > 35 ? acolhido.nome.substring(0, 35) + '...' : acolhido.nome,
                        acolhido.tecnico && acolhido.tecnico.length > 25 ? acolhido.tecnico.substring(0, 25) + '...' : (acolhido.tecnico || 'N/A'),
                        restricao
                    ];
                    
                    rowData.forEach((cell, cellIndex) => {
                        doc.text(cell, xPosition + 2, yPosition + 5);
                        xPosition += colWidthsFora[cellIndex];
                    });
                    
                    yPosition += 8;
                });
                
                yPosition += 15;
            }
            
            // ========== SEÇÃO: MOVIMENTAÇÕES ==========
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 77, 77); // Verde ADRA
            doc.text('📋 MOVIMENTAÇÕES DO PERÍODO', margin, yPosition);
            yPosition += 8;
            
            // Linha divisória
            doc.setDrawColor(0, 77, 77);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // Cabeçalho da tabela de movimentações
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(0, 77, 77);
            doc.setTextColor(255, 255, 255);
            
            const colWidths = [25, 20, 20, 45, 30, 30];
            const headers = ['Data', 'Hora', 'Tipo', 'Acolhido', 'Técnico', 'Observação'];
            
            let xPosition = margin;
            headers.forEach((header, index) => {
                doc.rect(xPosition, yPosition, colWidths[index], 8, 'F');
                doc.text(header, xPosition + 2, yPosition + 5);
                xPosition += colWidths[index];
            });
            
            yPosition += 8;
            
            // Conteúdo da tabela de movimentações
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            dados.movements.forEach((mov, index) => {
                // Verificar se precisa de nova página
                if (yPosition > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    yPosition = margin;
                    
                    // Redesenhar cabeçalho da tabela em nova página
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setFillColor(0, 77, 77);
                    doc.setTextColor(255, 255, 255);
                    
                    xPosition = margin;
                    headers.forEach((header, idx) => {
                        doc.rect(xPosition, yPosition, colWidths[idx], 8, 'F');
                        doc.text(header, xPosition + 2, yPosition + 5);
                        xPosition += colWidths[idx];
                    });
                    
                    yPosition += 8;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                }
                
                // Dados da movimentação
                const movDate = new Date(mov.data_hora);
                const data = movDate.toLocaleDateString('pt-BR');
                const hora = movDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const tipo = mov.tipo === 'entrada' ? 'ENTRADA' : 'SAÍDA';
                const acolhidoNome = mov.acolhidos?.nome || 'N/A';
                const tecnico = mov.tecnico_responsavel || 'N/A';
                const observacao = mov.observacao && mov.observacao !== 'Sem observação' ? 
                                (mov.observacao.length > 25 ? mov.observacao.substring(0, 25) + '...' : mov.observacao) : '-';
                
                const rowData = [data, hora, tipo, acolhidoNome, tecnico, observacao];
                
                // Alternar cores das linhas
                if (index % 2 === 0) {
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPosition, pageWidth - (2 * margin), 8, 'F');
                }
                
                xPosition = margin;
                rowData.forEach((cell, cellIndex) => {
                    doc.text(cell, xPosition + 2, yPosition + 5);
                    xPosition += colWidths[cellIndex];
                });
                
                yPosition += 8;
            });
            
            // Rodapé
            yPosition += 10;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(100, 100, 100);
            doc.text('Sistema de Gerenciamento de Acolhidos - ADRA', pageWidth / 2, yPosition, { align: 'center' });
            
            // Salvar PDF
            const fileName = `relatorio_completo_${dataInicio}_a_${dataFim}.pdf`;
            doc.save(fileName);
            
            showMessageBox(`✅ PDF gerado com sucesso!\n\nArquivo: ${fileName}\n\n• Movimentações: ${dados.movements.length}\n• Acolhidos fora: ${dados.acolhidosFora.length}`);
        }

        // FUNÇÃO AUXILIAR: Formatar data para exibição
        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // FUNÇÃO: Exportar para Excel
        function exportToExcel() {
            if (!allAcolhidos.length) {
                showMessageBox('Nenhum dado disponível para exportar.');
                return;
            }

            try {
                // Criar worksheet
                const ws = XLSX.utils.json_to_sheet(allAcolhidos);
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Acolhidos');
                
                // Gerar arquivo Excel
                XLSX.writeFile(wb, 'acolhidos_adra.xlsx');
                
                showMessageBox('✅ Arquivo Excel exportado com sucesso!\n\nNome: acolhidos_adra.xlsx');
                
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showMessageBox('Erro ao exportar para Excel: ' + error.message);
            }
        }

        // =============================================
        // FUNÇÕES CORRIGIDAS PARA SINCRONIZAÇÃO DE ABAS DE TÉCNICOS
        // =============================================

        // FUNÇÃO CORRIGIDA: Sincronizar abas de técnicos
        async function syncTecnicosSheets() {
            const sheetUrl = prompt('Cole a URL da planilha do Google Sheets com as abas dos técnicos:\n\nA planilha deve estar configurada como "Qualquer pessoa com o link pode visualizar"');
            if (!sheetUrl) return;

            try {
                showMessageBox('Buscando abas de técnicos...\n\nAguarde alguns segundos.');
                
                const sheetId = extractSheetId(sheetUrl);
                if (!sheetId) {
                    throw new Error('URL da planilha inválida. Certifique-se de que é uma URL do Google Sheets.');
                }
                
                // Buscar todas as abas disponíveis
                const availableSheets = await getAllAvailableSheets(sheetId);
                
                if (availableSheets.length === 0) {
                    showMessageBox('Nenhuma aba válida encontrada na planilha.');
                    return;
                }
                
                // Mostrar interface de seleção
                showTecnicosSheetSelection(sheetId, availableSheets);
                
            } catch (error) {
                console.error('Erro ao carregar planilha:', error);
                showMessageBox('Erro ao carregar planilha: ' + error.message);
            }
        }

        // FUNÇÃO AUXILIAR: Buscar todas as abas disponíveis com verificação de estrutura
        async function getAllAvailableSheets(sheetId) {
            const commonSheets = [
                'TÉC.ANA', 'TÉC.LENIR', 'TÉC.DOUGLAS', 'TÉC.JOÃO',
                'TEC.ANA', 'TEC.LENIR', 'TEC.DOUGLAS', 'TEC.JOÃO',
                'TEC ANA', 'TEC LENIR', 'TEC DOUGLAS', 'TEC JOÃO',
                'ANA', 'LENIR', 'DOUGLAS', 'JOÃO'
            ];
            
            const foundSheets = [];
            
            for (const sheetName of commonSheets) {
                try {
                    const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                    const response = await fetch(sheetUrl);
                    
                    if (response.ok) {
                        const text = await response.text();
                        if (!text.includes('error') && text.length > 100) {
                            // Verificar se a aba tem a estrutura correta
                            const json = JSON.parse(text.substring(47).slice(0, -2));
                            if (hasCorrectStructure(json)) {
                                foundSheets.push(sheetName);
                            }
                        }
                    }
                } catch (e) {
                    // Continua para a próxima aba
                }
            }
            
            return foundSheets;
        }

        // FUNÇÃO AUXILIAR: Verificar se a aba tem estrutura correta
        function hasCorrectStructure(sheetData) {
            if (!sheetData?.table?.rows) return false;
            
            // Verificar nas primeiras 5 linhas se tem os cabeçalhos esperados
            for (let i = 0; i < Math.min(sheetData.table.rows.length, 5); i++) {
                if (sheetData.table.rows[i]?.c) {
                    const headerRow = sheetData.table.rows[i].c;
                    const headerText = headerRow.map(cell => getCellDisplayValue(cell)).join(' ').toUpperCase();
                    
                    if (headerText.includes('DATA ÚLTIMO ACOMPANHAMENTO') && 
                        headerText.includes('NOME') &&
                        headerText.includes('DATA DE INGRESSO')) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // FUNÇÃO CORRIGIDA: Mostrar interface de seleção de abas
        function showTecnicosSheetSelection(sheetId, availableSheets) {
            const popupContent = document.getElementById('popupContent');
            const dataPopup = document.getElementById('dataPopup');
            
            let html = `
                <div class="sheet-selection">
                    <h4>👨‍⚕️ Selecione as Abas de Técnicos</h4>
                    
                    <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                        <strong>📋 Estrutura esperada (Dados Cadastrais):</strong><br>
                        • Cabeçalhos: DATA ÚLTIMO ACOMPANHAMENTO, NOME, DATA DE INGRESSO, etc.<br>
                        • Colunas: Dados completos dos acolhidos<br>
                        • <strong>Busca por nome na coluna "NOME"</strong>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <button onclick="selectAllTecSheets()" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-check-square"></i> Selecionar Todas
                        </button>
                        <button onclick="deselectAllTecSheets()" style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times-circle"></i> Desmarcar Todas
                        </button>
                    </div>
                    
                    <h5 style="color: #005952; margin: 15px 0 8px 0;">Abas Disponíveis (com estrutura correta):</h5>
                    <div class="sheets-container" id="tecSheetsContainer">
            `;
            
            availableSheets.forEach((sheetName, index) => {
                html += `
                    <div class="sheet-option" onclick="toggleTecSheetSelection(this, '${sheetName}')" 
                         style="cursor: pointer; text-align: left; padding: 10px; border: 2px solid #005952; border-radius: 8px; background: white; margin-bottom: 8px;">
                        <input type="checkbox" id="tec-sheet-${index}" checked
                               style="margin-right: 8px;" onchange="event.stopPropagation()">
                        <label for="tec-sheet-${index}" style="cursor: pointer; margin: 0;">
                            ${sheetName}
                        </label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="loadSelectedTecSheets('${sheetId}')" 
                                style="background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold;">
                            <i class="fas fa-download"></i> Carregar Dados Cadastrais
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="close-popup" onclick="closeDataPopup()">
                            <i class="fas fa-times"></i> Fechar
                        </button>
                    </div>
                </div>
                
                <div id="tecnicos-data-container" style="display: none; margin-top: 20px;"></div>
            `;
            
            popupContent.innerHTML = html;
            dataPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        // FUNÇÃO CORRIGIDA: Processar dados das abas de técnicos - ESTRUTURA CORRETA
        function processTecSheetData(sheetData, sheetName) {
            if (!sheetData?.table?.rows) {
                return [];
            }
            
            const rows = sheetData.table.rows;
            const processedData = [];
            
            console.log(`Processando aba: ${sheetName}`);
            console.log(`Total de linhas: ${rows.length}`);
            
            // Procurar pela linha que contém os cabeçalhos corretos
            let headerRowIndex = -1;
            
            // Buscar linha com cabeçalhos esperados
            for (let i = 0; i < Math.min(rows.length, 5); i++) {
                if (rows[i]?.c) {
                    const headerRow = rows[i].c;
                    const headerText = headerRow.map(cell => getCellDisplayValue(cell)).join(' ').toUpperCase();
                    
                    // Verificar se contém os cabeçalhos esperados
                    if (headerText.includes('DATA ÚLTIMO ACOMPANHAMENTO') && 
                        headerText.includes('NOME') &&
                        headerText.includes('DATA DE INGRESSO')) {
                        headerRowIndex = i;
                        console.log(`✅ Cabeçalhos encontrados na linha ${i + 1}`);
                        break;
                    }
                }
            }
            
            if (headerRowIndex === -1) {
                console.log('❌ Cabeçalhos não encontrados nas primeiras 5 linhas');
                // Tentar encontrar qualquer linha que tenha dados válidos
                headerRowIndex = 0;
            }
            
            // Mapeamento das colunas baseado na estrutura fornecida
            const columnMapping = {
                data_ultimo_acompanhamento: -1,
                nome: -1,
                data_de_ingresso: -1,
                data_de_nascimento: -1,
                idade: -1,
                faixa_etaria: -1,
                leito_quarto: -1,
                tipo_de_leito: -1,
                renda: -1,
                spa: -1,
                laudros: -1,
                vinculos_familiar: -1,
                demandante: -1,
                plano_individual: -1,
                rg: -1,
                cpf: -1,
                sus: -1,
                nis: -1,
                gov_br: -1,
                quadro_clinico: -1,
                medicacao: -1
            };
            
            // Mapear colunas baseado nos cabeçalhos
            if (rows[headerRowIndex]?.c) {
                const headerRow = rows[headerRowIndex].c;
                
                headerRow.forEach((cell, index) => {
                    const headerText = getCellDisplayValue(cell).toUpperCase();
                    
                    if (headerText.includes('DATA ÚLTIMO ACOMPANHAMENTO')) columnMapping.data_ultimo_acompanhamento = index;
                    else if (headerText.includes('NOME')) columnMapping.nome = index;
                    else if (headerText.includes('DATA DE INGRESSO')) columnMapping.data_de_ingresso = index;
                    else if (headerText.includes('DATA DE NASCIMENTO')) columnMapping.data_de_nascimento = index;
                    else if (headerText.includes('IDADE')) columnMapping.idade = index;
                    else if (headerText.includes('FAIXA ETARIA')) columnMapping.faixa_etaria = index;
                    else if (headerText.includes('LEITO/QUARTO') || headerText.includes('LEITO QUARTO')) columnMapping.leito_quarto = index;
                    else if (headerText.includes('TIPO DE LEITO')) columnMapping.tipo_de_leito = index;
                    else if (headerText.includes('RENDA')) columnMapping.renda = index;
                    else if (headerText.includes('S.P.A')) columnMapping.spa = index;
                    else if (headerText.includes('LAUDOS')) columnMapping.laudros = index;
                    else if (headerText.includes('VINCULOS FAMILIAR')) columnMapping.vinculos_familiar = index;
                    else if (headerText.includes('DEMANDANTE')) columnMapping.demandante = index;
                    else if (headerText.includes('PLANO INDIVIDUAL')) columnMapping.plano_individual = index;
                    else if (headerText.includes('RG')) columnMapping.rg = index;
                    else if (headerText.includes('CPF')) columnMapping.cpf = index;
                    else if (headerText.includes('SUS')) columnMapping.sus = index;
                    else if (headerText.includes('NIS')) columnMapping.nis = index;
                    else if (headerText.includes('GOV.BR')) columnMapping.gov_br = index;
                    else if (headerText.includes('QUADRO CLINICO') || headerText.includes('QUADRO CLÍNICO')) columnMapping.quadro_clinico = index;
                    else if (headerText.includes('MEDICAÇÃO') || headerText.includes('MEDICACAO')) columnMapping.medicacao = index;
                });
                
                console.log('Mapeamento de colunas:', columnMapping);
            }
            
            // Processar dados a partir da linha seguinte aos cabeçalhos
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row?.c) continue;
                
                const nome = columnMapping.nome >= 0 ? getCellDisplayValue(row.c[columnMapping.nome]) : '';
                
                // Pular linhas vazias ou inválidas
                if (!nome || 
                    nome.trim() === '' || 
                    nome.toUpperCase().includes('NOME') ||
                    nome.toUpperCase().includes('TOTAL') ||
                    nome.trim().length < 2) {
                    continue;
                }
                
                const rowData = {
                    sheet_name: sheetName,
                    nome: nome,
                    data_ultimo_acompanhamento: columnMapping.data_ultimo_acompanhamento >= 0 ? getCellDisplayValue(row.c[columnMapping.data_ultimo_acompanhamento]) : '',
                    data_de_ingresso: columnMapping.data_de_ingresso >= 0 ? getCellDisplayValue(row.c[columnMapping.data_de_ingresso]) : '',
                    data_de_nascimento: columnMapping.data_de_nascimento >= 0 ? getCellDisplayValue(row.c[columnMapping.data_de_nascimento]) : '',
                    idade: columnMapping.idade >= 0 ? getCellDisplayValue(row.c[columnMapping.idade]) : '',
                    faixa_etaria: columnMapping.faixa_etaria >= 0 ? getCellDisplayValue(row.c[columnMapping.faixa_etaria]) : '',
                    leito_quarto: columnMapping.leito_quarto >= 0 ? getCellDisplayValue(row.c[columnMapping.leito_quarto]) : '',
                    tipo_de_leito: columnMapping.tipo_de_leito >= 0 ? getCellDisplayValue(row.c[columnMapping.tipo_de_leito]) : '',
                    renda: columnMapping.renda >= 0 ? getCellDisplayValue(row.c[columnMapping.renda]) : '',
                    spa: columnMapping.spa >= 0 ? getCellDisplayValue(row.c[columnMapping.spa]) : '',
                    laudros: columnMapping.laudros >= 0 ? getCellDisplayValue(row.c[columnMapping.laudros]) : '',
                    vinculos_familiar: columnMapping.vinculos_familiar >= 0 ? getCellDisplayValue(row.c[columnMapping.vinculos_familiar]) : '',
                    demandante: columnMapping.demandante >= 0 ? getCellDisplayValue(row.c[columnMapping.demandante]) : '',
                    plano_individual: columnMapping.plano_individual >= 0 ? getCellDisplayValue(row.c[columnMapping.plano_individual]) : '',
                    rg: columnMapping.rg >= 0 ? getCellDisplayValue(row.c[columnMapping.rg]) : '',
                    cpf: columnMapping.cpf >= 0 ? getCellDisplayValue(row.c[columnMapping.cpf]) : '',
                    sus: columnMapping.sus >= 0 ? getCellDisplayValue(row.c[columnMapping.sus]) : '',
                    nis: columnMapping.nis >= 0 ? getCellDisplayValue(row.c[columnMapping.nis]) : '',
                    gov_br: columnMapping.gov_br >= 0 ? getCellDisplayValue(row.c[columnMapping.gov_br]) : '',
                    quadro_clinico: columnMapping.quadro_clinico >= 0 ? getCellDisplayValue(row.c[columnMapping.quadro_clinico]) : '',
                    medicacao: columnMapping.medicacao >= 0 ? getCellDisplayValue(row.c[columnMapping.medicacao]) : ''
                };
                
                // DEBUG: Log para verificar os dados
                console.log(`Linha ${i + 1} - Nome: "${rowData.nome}"`);
                
                processedData.push(rowData);
            }
            
            console.log(`✅ Dados processados de ${sheetName}: ${processedData.length} registros`);
            return processedData;
        }

        // FUNÇÃO CORRIGIDA: Carregar abas de técnicos selecionadas
        async function loadSelectedTecSheets(sheetId) {
            const selectedSheets = [];
            
            document.querySelectorAll('#tecSheetsContainer .sheet-option input[type="checkbox"]:checked').forEach(checkbox => {
                const label = checkbox.closest('.sheet-option').querySelector('label');
                const sheetName = label.textContent.trim();
                selectedSheets.push(sheetName);
            });
            
            if (selectedSheets.length === 0) {
                showMessageBox('Por favor, selecione pelo menos uma aba.');
                return;
            }
            
            showMessageBox(`Carregando ${selectedSheets.length} aba(s)...\n\n${selectedSheets.join(', ')}`);
            
            try {
                let allData = [];
                let loadedSheets = [];
                
                for (const sheetName of selectedSheets) {
                    try {
                        const sheetData = await fetchGoogleSheetData(sheetId, sheetName);
                        const processedData = processTecSheetData(sheetData, sheetName);
                        
                        if (processedData.length > 0) {
                            allData = allData.concat(processedData);
                            loadedSheets.push(sheetName);
                        }
                    } catch (error) {
                        console.error(`Erro ao carregar ${sheetName}:`, error);
                    }
                }
                
                if (allData.length === 0) {
                    showMessageBox('Nenhum dado válido encontrado nas abas selecionadas.');
                    return;
                }
                
                // Armazenar dados globalmente para busca
                window.tecSheetsData = allData;
                
                // Mostrar dados com interface de busca
                displayTecnicosDataWithSearch(allData, loadedSheets);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showMessageBox('Erro ao carregar dados: ' + error.message);
            }
        }

        // FUNÇÃO NOVA: Mostrar dados com interface de busca
        function displayTecnicosDataWithSearch(data, loadedSheets) {
            const container = document.getElementById('tecnicos-data-container');
            
            let html = `
                <div class="sheet-selection">
                    <h4>👨‍⚕️ Dados dos Técnicos Carregados</h4>
                    
                    <div class="sheet-info" style="background: #e8f5e9; margin-bottom: 15px;">
                        <strong>📊 Resumo:</strong><br>
                        • Abas carregadas: ${loadedSheets.join(', ')}<br>
                        • Total de registros: ${data.length}<br>
                        • <strong>Busca por nome na coluna "NOME"</strong>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="search-input-container">
                            <input type="text" id="search-tec-nome" placeholder="Buscar por nome..." 
                                   style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <button onclick="searchTecData()" style="background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <button onclick="exportTecDataToExcel()" style="background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button onclick="showAllTecData()" style="background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-eye"></i> Ver Todos
                        </button>
                    </div>
                    
                    <div id="tecnicos-results-container">
            `;
            
            // Mostrar primeiros 20 registros
            const displayData = data.slice(0, 20);
            html += generateTecnicosTable(displayData);
            
            if (data.length > 20) {
                html += `<div style="text-align: center; color: #7f8c8d; margin-top: 10px;">
                    Mostrando 20 de ${data.length} registros. Use a busca para encontrar registros específicos.
                </div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Configurar busca por Enter
            document.getElementById('search-tec-nome').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchTecData();
                }
            });
        }

        // FUNÇÃO: Buscar dados de técnicos por nome
        function searchTecData() {
            const searchTerm = document.getElementById('search-tec-nome').value.trim().toLowerCase();
            const allData = window.tecSheetsData || [];
            
            if (!searchTerm) {
                showAllTecData();
                return;
            }
            
            const filteredData = allData.filter(item => 
                item.nome && item.nome.toLowerCase().includes(searchTerm)
            );
            
            const resultsContainer = document.getElementById('tecnicos-results-container');
            
            if (filteredData.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                        <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px;"></i><br>
                        Nenhum resultado encontrado para: "${searchTerm}"
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = `
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>${filteredData.length} resultado(s) encontrado(s) para: "${searchTerm}"</strong>
                    </div>
                    ${generateTecnicosTable(filteredData)}
                `;
            }
        }

        // FUNÇÃO: Mostrar todos os dados
        function showAllTecData() {
            const allData = window.tecSheetsData || [];
            const resultsContainer = document.getElementById('tecnicos-results-container');
            const displayData = allData.slice(0, 50); // Limitar a 50 registros
            
            resultsContainer.innerHTML = generateTecnicosTable(displayData);
            
            if (allData.length > 50) {
                resultsContainer.innerHTML += `<div style="text-align: center; color: #7f8c8d; margin-top: 10px;">
                    Mostrando 50 de ${allData.length} registros. Use a busca para encontrar registros específicos.
                </div>`;
            }
        }

        // FUNÇÃO: Gerar tabela de dados dos técnicos
        function generateTecnicosTable(data) {
            if (data.length === 0) {
                return '<p style="text-align: center; color: #7f8c8d;">Nenhum dado para exibir.</p>';
            }
            
            let html = `
                <div style="overflow-x: auto; max-height: 400px;">
                    <table class="data-table">
                        <tr>
                            <th>Aba</th>
                            <th>Nome</th>
                            <th>Data Último Acomp.</th>
                            <th>Data Ingresso</th>
                            <th>Idade</th>
                            <th>Leito/Quarto</th>
                            <th>Demandante</th>
                            <th>Quadro Clínico</th>
                        </tr>
            `;
            
            data.forEach((item, index) => {
                html += `
                    <tr>
                        <td><small>${item.sheet_name}</small></td>
                        <td><strong>${item.nome || 'N/A'}</strong></td>
                        <td>${item.data_ultimo_acompanhamento || 'N/A'}</td>
                        <td>${item.data_de_ingresso || 'N/A'}</td>
                        <td>${item.idade || 'N/A'}</td>
                        <td>${item.leito_quarto || 'N/A'}</td>
                        <td>${item.demandante || 'N/A'}</td>
                        <td title="${item.quadro_clinico || ''}">
                            ${item.quadro_clinico ? 
                              (item.quadro_clinico.length > 30 ? item.quadro_clinico.substring(0, 30) + '...' : item.quadro_clinico) : 
                              'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            html += `</table></div>`;
            return html;
        }

        // FUNÇÃO CORRIGIDA: Exportar dados dos técnicos para Excel
        function exportTecDataToExcel() {
            if (!window.tecSheetsData || window.tecSheetsData.length === 0) {
                showMessageBox('Nenhum dado disponível para exportar.');
                return;
            }
            
            try {
                // Preparar dados para exportação com estrutura CORRETA
                const exportData = window.tecSheetsData.map(item => ({
                    'Aba': item.sheet_name,
                    'NOME': item.nome,
                    'DATA ÚLTIMO ACOMPANHAMENTO': item.data_ultimo_acompanhamento,
                    'DATA DE INGRESSO': item.data_de_ingresso,
                    'DATA DE NASCIMENTO': item.data_de_nascimento,
                    'IDADE': item.idade,
                    'FAIXA ETARIA': item.faixa_etaria,
                    'LEITO/QUARTO': item.leito_quarto,
                    'TIPO DE LEITO': item.tipo_de_leito,
                    'RENDA': item.renda,
                    'S.P.A': item.spa,
                    'LAUDOS': item.laudros,
                    'VINCULOS FAMILIAR': item.vinculos_familiar,
                    'DEMANDANTE': item.demandante,
                    'PLANO INDIVIDUAL': item.plano_individual,
                    'RG': item.rg,
                    'CPF': item.cpf,
                    'SUS': item.sus,
                    'NIS': item.nis,
                    'GOV.BR': item.gov_br,
                    'Quadro Clinico': item.quadro_clinico,
                    'Medicação': item.medicacao
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Dados_Técnicos');
                XLSX.writeFile(wb, 'dados_tecnicos_adra.xlsx');
                
                showMessageBox('✅ Arquivo Excel exportado com sucesso!\n\nNome: dados_tecnicos_adra.xlsx\n\nEstrutura: Dados cadastrais dos acolhidos');
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showMessageBox('Erro ao exportar para Excel: ' + error.message);
            }
        }

        // FUNÇÃO: Alternar seleção de aba de técnico
        function toggleTecSheetSelection(element, sheetName) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.style.background = '#e8f5e9';
                element.style.borderColor = '#27ae60';
            } else {
                element.style.background = 'white';
                element.style.borderColor = '#005952';
            }
        }

        // FUNÇÃO: Selecionar todas as abas
        function selectAllTecSheets() {
            document.querySelectorAll('#tecSheetsContainer .sheet-option input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            document.querySelectorAll('#tecSheetsContainer .sheet-option').forEach(option => {
                option.style.background = '#e8f5e9';
                option.style.borderColor = '#27ae60';
            });
        }

        // FUNÇÃO: Desmarcar todas as abas
        function deselectAllTecSheets() {
            document.querySelectorAll('#tecSheetsContainer .sheet-option input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#tecSheetsContainer .sheet-option').forEach(option => {
                option.style.background = 'white';
                option.style.borderColor = '#005952';
            });
        }

        // FUNÇÃO: Fechar pop-up de dados
        function closeDataPopup() {
            document.getElementById('dataPopup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // INICIALIZAÇÃO DO SISTEMA
        document.addEventListener('DOMContentLoaded', function() {
            promptAccessLevel();
            loadAcolhidos();
            loadMovements();
            setupSearchAutocomplete();
            setupSearchEnterKey();
        });
    </script>
</body>
</html>
[file content end]